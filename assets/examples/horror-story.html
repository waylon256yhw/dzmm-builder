<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ·±å¤œæ¥å®¢ - ææ€–äº’åŠ¨æ•…äº‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      overflow-x: hidden;
      transition: filter 0.5s, background-color 0.5s;
      position: relative;
    }

    /* å™ªç‚¹èƒŒæ™¯ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15),
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1;
      animation: scanlines 8s linear infinite;
    }

    @keyframes scanlines {
      0% { transform: translateY(0); }
      100% { transform: translateY(20px); }
    }

    /* å…‰çº¿çŠ¶æ€ */
    body.lights-normal {
      background: #1a1a1a;
      filter: brightness(1);
    }

    body.lights-dim {
      background: #0a0a0a;
      filter: brightness(0.6);
    }

    body.lights-off {
      background: #000000;
      filter: brightness(0.2);
    }

    body.lights-flicker {
      animation: flicker 0.15s ease-in-out 5;
    }

    @keyframes flicker {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(0.3); }
    }

    /* æŠ–åŠ¨æ•ˆæœ */
    body.shake-low {
      animation: shake-low 0.3s;
    }

    body.shake-medium {
      animation: shake-medium 0.5s;
    }

    body.shake-high {
      animation: shake-high 0.8s;
    }

    @keyframes shake-low {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-3px, 3px); }
      75% { transform: translate(3px, -3px); }
    }

    @keyframes shake-medium {
      0%, 100% { transform: translate(0, 0); }
      10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px) rotate(0.5deg); }
      20%, 40%, 60%, 80% { transform: translate(5px, -5px) rotate(-0.5deg); }
    }

    @keyframes shake-high {
      0%, 100% { transform: translate(0, 0); }
      10%, 30%, 50%, 70%, 90% { transform: translate(-10px, 10px) rotate(1deg); }
      20%, 40%, 60%, 80% { transform: translate(10px, -10px) rotate(-1deg); }
    }

    /* æ•…éšœæ•ˆæœ */
    body.glitch {
      animation: glitch 0.3s infinite;
    }

    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); filter: hue-rotate(0deg); }
      40% { transform: translate(-2px, -2px); filter: hue-rotate(90deg); }
      60% { transform: translate(2px, 2px); filter: hue-rotate(180deg); }
      80% { transform: translate(2px, -2px); filter: hue-rotate(270deg); }
      100% { transform: translate(0); filter: hue-rotate(360deg); }
    }

    /* æ»¤é•œæ•ˆæœ */
    body.filter-blood {
      background: linear-gradient(180deg,
        rgba(139, 0, 0, 0.3) 0%,
        rgba(0, 0, 0, 0) 50%,
        rgba(139, 0, 0, 0.3) 100%
      ), #0a0a0a;
    }

    body.filter-blur {
      filter: blur(2px);
    }

    /* ç”»å¸ƒ */
    #particle-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    /* ä¸»å®¹å™¨ */
    #app {
      position: relative;
      z-index: 3;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      min-height: 100vh;
    }

    /* æ ‡é¢˜ */
    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeIn 2s ease-in;
    }

    .header h1 {
      font-size: 36px;
      color: #8b0000;
      text-shadow: 0 0 10px rgba(139, 0, 0, 0.5),
                   0 0 20px rgba(139, 0, 0, 0.3);
      margin-bottom: 10px;
      letter-spacing: 4px;
    }

    .header .subtitle {
      font-size: 14px;
      color: #666;
      letter-spacing: 2px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* è­¦å‘Šæ¡† */
    .warning {
      background: rgba(139, 0, 0, 0.1);
      border: 1px solid #8b0000;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
    }

    .warning h3 {
      color: #ff4444;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .warning p {
      font-size: 14px;
      line-height: 1.6;
      color: #ccc;
      margin-bottom: 15px;
    }

    .warning button {
      background: #8b0000;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: background 0.3s;
    }

    .warning button:hover {
      background: #a00000;
    }

    /* å¯¹è¯åŒº */
    .chat-container {
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .chat-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }

    .message {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      line-height: 1.8;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: rgba(30, 30, 60, 0.6);
      border-left: 3px solid #4a4a8a;
      margin-left: 40px;
    }

    .message.assistant {
      background: rgba(40, 20, 20, 0.6);
      border-left: 3px solid #8b0000;
      margin-right: 40px;
    }

    .message .role {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .message.assistant .role {
      color: #ff6666;
    }

    .message .content {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .typing-indicator {
      display: inline-block;
      padding: 15px;
      background: rgba(40, 20, 20, 0.6);
      border-left: 3px solid #8b0000;
      border-radius: 8px;
      margin-right: 40px;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #8b0000;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-10px); }
    }

    /* è¾“å…¥åŒº */
    .input-area {
      display: flex;
      gap: 10px;
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
    }

    .input-area input {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 12px 15px;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .input-area input:focus {
      outline: none;
      border-color: #8b0000;
    }

    .input-area input::placeholder {
      color: #666;
    }

    .input-area button {
      background: #8b0000;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: background 0.3s;
      white-space: nowrap;
    }

    .input-area button:hover:not(:disabled) {
      background: #a00000;
    }

    .input-area button:disabled {
      background: #444;
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* æ§åˆ¶é¢æ¿ */
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .controls button {
      background: rgba(40, 40, 40, 0.8);
      color: #999;
      border: 1px solid #444;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
    }

    .controls button:hover {
      background: rgba(60, 60, 60, 0.8);
      color: #ccc;
      border-color: #666;
    }

    /* æƒŠå“å¼¹å‡º */
    .jumpscare {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: rgba(0, 0, 0, 0.95);
      color: #ff0000;
      font-size: 48px;
      font-weight: bold;
      padding: 40px 60px;
      border: 3px solid #ff0000;
      border-radius: 12px;
      z-index: 9999;
      text-align: center;
      text-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
      animation: jumpscare 0.5s ease-out forwards;
      pointer-events: none;
    }

    @keyframes jumpscare {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(0deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* å“åº”å¼ */
    @media (max-width: 600px) {
      .header h1 {
        font-size: 28px;
      }

      .message.user {
        margin-left: 20px;
      }

      .message.assistant {
        margin-right: 20px;
      }

      .jumpscare {
        font-size: 32px;
        padding: 30px 40px;
      }
    }
  </style>
</head>
<body class="lights-dim">
  <canvas id="particle-canvas"></canvas>

  <div id="app" x-data="horrorApp">
    <!-- è­¦å‘Šé¡µé¢ -->
    <div x-show="!started" class="warning">
      <h3>âš ï¸ è­¦å‘Š âš ï¸</h3>
      <p>æœ¬åº”ç”¨åŒ…å«ææ€–/æ‚¬ç–‘å†…å®¹ï¼Œå¯èƒ½å¼•èµ·ä¸é€‚ã€‚</p>
      <p>å»ºè®®åœ¨æ˜æš—ç¯å¢ƒä¸‹ç‹¬è‡ªä½“éªŒï¼Œå¹¶ä½©æˆ´è€³æœºä»¥è·å¾—æœ€ä½³æ•ˆæœã€‚</p>
      <p>AI å°†åœ¨æ•…äº‹è®²è¿°è¿‡ç¨‹ä¸­æ§åˆ¶é¡µé¢çš„è§†è§‰å’ŒéŸ³æ•ˆï¼Œè¥é€ æ²‰æµ¸å¼ä½“éªŒã€‚</p>
      <p style="margin-top: 15px; color: #ff6666;">
        <strong>å¦‚æœ‰å¿ƒè„ç–¾ç—…æˆ–å¯¹æƒŠå“å†…å®¹æ•æ„Ÿï¼Œè¯·å‹¿ç»§ç»­ã€‚</strong>
      </p>
      <button @click="startExperience">æˆ‘å·²å‡†å¤‡å¥½è¿›å…¥</button>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div x-show="started" style="display: none;">
      <div class="header">
        <h1>æ·±å¤œæ¥å®¢</h1>
        <p class="subtitle">AI é©±åŠ¨çš„ææ€–äº’åŠ¨æ•…äº‹</p>
      </div>

      <div class="chat-container" x-ref="chatContainer">
        <template x-for="msg in messages" :key="msg.id">
          <div :class="'message ' + msg.role">
            <span class="role" x-text="msg.role === 'user' ? 'ä½ ' : 'å™äº‹è€…'"></span>
            <div class="content" x-text="msg.content"></div>
          </div>
        </template>

        <div x-show="loading" class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <div class="input-area">
        <input
          x-model="userInput"
          @keydown.enter="sendMessage"
          placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨æˆ–æŒ‡ä»¤..."
          :disabled="loading"
          type="text">
        <button @click="sendMessage" :disabled="loading || !userInput.trim()">
          å‘é€
        </button>
      </div>

      <div class="controls">
        <button @click="resetStory">ğŸ”„ é‡æ–°å¼€å§‹</button>
        <button @click="testEffects">ğŸ¬ æµ‹è¯•æ•ˆæœ</button>
        <button @click="toggleSafeMode">
          <span x-text="safeMode ? 'ğŸ”Š å¼€å¯æ•ˆæœ' : 'ğŸ”‡ å®‰å…¨æ¨¡å¼'"></span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== ç²’å­ç³»ç»Ÿ ====================
    class ParticleSystem {
      constructor() {
        this.canvas = document.getElementById('particle-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.particles = [];
        this.animating = false;
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // å¯åŠ¨ç¯å¢ƒç²’å­ï¼ˆç°å°˜ï¼‰
        this.startAmbientParticles();
      }

      resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      }

      startAmbientParticles() {
        // åˆ›å»º 20 ä¸ªæ¼‚æµ®çš„ç°å°˜ç²’å­
        for (let i = 0; i < 20; i++) {
          this.particles.push({
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            vx: (Math.random() - 0.5) * 0.3,
            vy: Math.random() * 0.2 - 0.4,
            size: Math.random() * 2 + 1,
            life: Infinity,
            color: `rgba(200, 200, 200, ${Math.random() * 0.3})`,
            type: 'ambient'
          });
        }
        if (!this.animating) this.animate();
      }

      bloodSplatter(x, y) {
        for (let i = 0; i < 50; i++) {
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 8 + 2;
          this.particles.push({
            x, y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed - 3,
            size: Math.random() * 4 + 2,
            life: 1.0,
            color: `rgba(139, 0, 0, ${Math.random() * 0.5 + 0.5})`,
            type: 'blood'
          });
        }
        if (!this.animating) this.animate();
      }

      animate() {
        this.animating = true;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        this.particles = this.particles.filter(p => {
          // æ›´æ–°ä½ç½®
          p.x += p.vx;
          p.y += p.vy;

          if (p.type === 'ambient') {
            // ç¯å¢ƒç²’å­å¾ªç¯
            if (p.x < 0) p.x = this.canvas.width;
            if (p.x > this.canvas.width) p.x = 0;
            if (p.y < 0) p.y = this.canvas.height;
            if (p.y > this.canvas.height) p.y = 0;
          } else {
            // è¡€æ¶²ç²’å­å—é‡åŠ›å½±å“
            p.vy += 0.3;
            p.life -= 0.015;
          }

          // ç»˜åˆ¶
          if (p.life > 0) {
            this.ctx.globalAlpha = p.type === 'ambient' ? 1 : p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();
            return true;
          }
          return p.type === 'ambient';
        });

        if (this.particles.length > 0) {
          requestAnimationFrame(() => this.animate());
        } else {
          this.animating = false;
        }
      }
    }

    // ==================== éŸ³æ•ˆç³»ç»Ÿ ====================
    class HorrorSoundSystem {
      constructor() {
        this.ctx = null;
        this.currentSounds = [];
      }

      init() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
      }

      // ä½é¢‘å—¡é¸£ï¼ˆææ€–æ°›å›´ï¼‰
      drone(duration = 3000, volume = 0.2) {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.type = 'sine';
        osc.frequency.setValueAtTime(60, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(80, this.ctx.currentTime + duration / 1000);

        gain.gain.setValueAtTime(volume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration / 1000);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration / 1000);

        this.currentSounds.push(osc);
      }

      // å¿ƒè·³éŸ³
      heartbeat(count = 3, volume = 0.3) {
        this.init();
        for (let i = 0; i < count; i++) {
          setTimeout(() => {
            // ç¬¬ä¸€ä¸‹
            this.beep(80, 100, volume);
            // ç¬¬äºŒä¸‹
            setTimeout(() => this.beep(60, 150, volume * 0.7), 150);
          }, i * 1000);
        }
      }

      // å°–å«/å°–é”éŸ³
      scream(duration = 500, volume = 0.2) {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(2000, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + duration / 1000);

        gain.gain.setValueAtTime(volume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration / 1000);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration / 1000);

        this.currentSounds.push(osc);
      }

      // åŸºç¡€éŸ³æ•ˆ
      beep(freq, duration, volume = 0.3) {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.frequency.value = freq;
        gain.gain.setValueAtTime(volume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration / 1000);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration / 1000);
      }

      // ç™½å™ªéŸ³ï¼ˆç´§å¼ æ„Ÿï¼‰
      whiteNoise(duration = 1000, volume = 0.1) {
        this.init();
        const bufferSize = this.ctx.sampleRate * duration / 1000;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);

        for (let i = 0; i < bufferSize; i++) {
          data[i] = Math.random() * 2 - 1;
        }

        const source = this.ctx.createBufferSource();
        const gain = this.ctx.createGain();

        source.buffer = buffer;
        gain.gain.value = volume;

        source.connect(gain);
        gain.connect(this.ctx.destination);
        source.start();

        this.currentSounds.push(source);
      }

      stopAll() {
        this.currentSounds.forEach(sound => {
          try {
            sound.stop();
          } catch (e) {
            // å¿½ç•¥å·²åœæ­¢çš„å£°éŸ³
          }
        });
        this.currentSounds = [];
      }
    }

    // åˆå§‹åŒ–å…¨å±€ç³»ç»Ÿ
    const particles = new ParticleSystem();
    const sounds = new HorrorSoundSystem();

    // ==================== æ•ˆæœæ‰§è¡Œå™¨ ====================
    function executeEffect(effect, safeMode = false) {
      if (safeMode && ['sound', 'jumpscare'].includes(effect.action)) {
        console.log('[å®‰å…¨æ¨¡å¼] è·³è¿‡æ•ˆæœ:', effect.action);
        return;
      }

      console.log('[æ‰§è¡Œæ•ˆæœ]', effect);

      const body = document.body;

      switch (effect.action) {
        case 'lights':
          // ç§»é™¤æ‰€æœ‰å…‰çº¿ç±»
          body.classList.remove('lights-normal', 'lights-dim', 'lights-off', 'lights-flicker');

          if (effect.params.state === 'flicker') {
            body.classList.add('lights-flicker');
            setTimeout(() => body.classList.remove('lights-flicker'), 800);
          } else {
            body.classList.add(`lights-${effect.params.state}`);
          }
          break;

        case 'shake':
          const intensity = effect.params.intensity || 'medium';
          body.classList.add(`shake-${intensity}`);
          setTimeout(() => {
            body.classList.remove(`shake-${intensity}`);
          }, effect.params.duration || 500);
          break;

        case 'glitch':
          body.classList.add('glitch');
          setTimeout(() => {
            body.classList.remove('glitch');
          }, effect.params.duration || 1000);
          break;

        case 'filter':
          body.classList.remove('filter-blood', 'filter-blur');
          if (effect.params.type) {
            body.classList.add(`filter-${effect.params.type}`);
            if (effect.params.duration) {
              setTimeout(() => {
                body.classList.remove(`filter-${effect.params.type}`);
              }, effect.params.duration);
            }
          }
          break;

        case 'sound':
          const soundType = effect.params.type || 'beep';
          const volume = effect.params.volume || 0.3;

          switch (soundType) {
            case 'drone':
              sounds.drone(effect.params.duration || 3000, volume);
              break;
            case 'heartbeat':
              sounds.heartbeat(effect.params.count || 3, volume);
              break;
            case 'scream':
              sounds.scream(effect.params.duration || 500, volume);
              break;
            case 'noise':
              sounds.whiteNoise(effect.params.duration || 1000, volume);
              break;
            default:
              sounds.beep(effect.params.frequency || 440, effect.params.duration || 200, volume);
          }
          break;

        case 'jumpscare':
          const div = document.createElement('div');
          div.className = 'jumpscare';
          div.textContent = effect.params.text || '!!!';
          document.body.appendChild(div);

          sounds.scream(300, 0.3);

          setTimeout(() => {
            div.style.animation = 'none';
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 300);
          }, effect.params.duration || 1500);
          break;

        case 'blood':
          const x = effect.params.x || window.innerWidth / 2;
          const y = effect.params.y || window.innerHeight / 2;
          particles.bloodSplatter(x, y);
          break;
      }
    }

    // ==================== Alpine.js åº”ç”¨ ====================
    document.addEventListener('alpine:init', () => {
      Alpine.data('horrorApp', () => ({
        started: false,
        messages: [],
        userInput: '',
        loading: false,
        safeMode: false,
        conversationHistory: [],

        async init() {
          // ç­‰å¾… DZMM API å°±ç»ª
          await new Promise((resolve) => {
            const handler = (event) => {
              if (event.data?.type === 'dzmm:ready') {
                window.removeEventListener('message', handler);
                resolve();
              }
            };
            window.addEventListener('message', handler);
          });
        },

        startExperience() {
          this.started = true;

          // åˆå§‹åŒ–éŸ³æ•ˆä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
          sounds.init();

          // æ·»åŠ å¼€åœºæ¶ˆæ¯
          this.messages.push({
            id: Date.now(),
            role: 'assistant',
            content: 'æ·±å¤œï¼Œä½ ç‹¬è‡ªåœ¨å®¶ã€‚çª—å¤–çš„é£å¹å¾—æ ‘ææ²™æ²™ä½œå“ã€‚\n\nçªç„¶ï¼Œä½ å¬åˆ°äº†ä¸€å£°è½»å¾®çš„æ•²é—¨å£°...\n\nä½ æ‰“ç®—æ€ä¹ˆåšï¼Ÿ'
          });

          // è®¾ç½®åˆå§‹æ°›å›´
          executeEffect({ action: 'lights', params: { state: 'dim' } });
          setTimeout(() => {
            executeEffect({ action: 'sound', params: { type: 'drone', duration: 5000, volume: 0.15 } });
          }, 1000);

          this.$nextTick(() => this.scrollToBottom());
        },

        async sendMessage() {
          if (!this.userInput.trim() || this.loading) return;

          const input = this.userInput.trim();
          this.userInput = '';

          // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
          this.messages.push({
            id: Date.now(),
            role: 'user',
            content: input
          });

          this.conversationHistory.push({
            role: 'user',
            content: input
          });

          this.loading = true;
          this.scrollToBottom();

          let response = '';

          // æ„å»ºç³»ç»Ÿæç¤ºè¯
          const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ææ€–æ•…äº‹å™äº‹è€…ã€‚ä½ æ­£åœ¨ä¸»æŒä¸€ä¸ªäº¤äº’å¼ææ€–ä½“éªŒï¼ŒåŒæ—¶ä½ æ‹¥æœ‰æ§åˆ¶ç”¨æˆ·æµè§ˆå™¨ç•Œé¢çš„èƒ½åŠ›ã€‚

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç‰¹æ®ŠæŒ‡ä»¤æ¥è¥é€ ææ€–æ°›å›´ï¼š

###EFFECT
{"action":"lights","params":{"state":"normal|dim|off|flicker"}}
{"action":"shake","params":{"intensity":"low|medium|high","duration":500}}
{"action":"glitch","params":{"duration":1000}}
{"action":"filter","params":{"type":"blood|blur","duration":3000}}
{"action":"sound","params":{"type":"drone|heartbeat|scream|noise","volume":0.3,"duration":3000}}
{"action":"jumpscare","params":{"text":"æƒŠå“æ–‡æœ¬","duration":1500}}
{"action":"blood","params":{"x":400,"y":300}}
###END

é‡è¦è§„åˆ™ï¼š
1. åœ¨é€‚å½“çš„ææ€–æ—¶åˆ»è‡ªç„¶åœ°ä½¿ç”¨è¿™äº›æ•ˆæœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨
2. å½“ç”¨æˆ·æ˜ç¡®è¦æ±‚æŸä¸ªæ•ˆæœæ—¶ï¼ˆå¦‚"å…³ç¯"ã€"å¼€ç¯"ï¼‰ï¼Œç«‹å³æ‰§è¡Œ
3. è®²è¿°ç”ŸåŠ¨çš„ææ€–æ•…äº‹ï¼Œç»“åˆè§†è§‰å’ŒéŸ³æ•ˆè¥é€ æ²‰æµ¸æ„Ÿ
4. æ•…äº‹åº”è¯¥æœ‰æ‚¬å¿µã€è½¬æŠ˜å’Œé«˜æ½®
5. æ¯æ¬¡å›åº” 100-200 å­—å·¦å³ï¼Œä¿æŒèŠ‚å¥ç´§å‡‘
6. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ¨è¿›å‰§æƒ…

å½“å‰åœºæ™¯ï¼šæ·±å¤œçš„æˆ¿é—´ï¼Œç”¨æˆ·åˆšå¬åˆ°æ•²é—¨å£°ã€‚æ ¹æ®ç”¨æˆ·çš„è¡ŒåŠ¨ç»§ç»­æ•…äº‹ã€‚`;

          const messages = [
            { role: 'user', content: systemPrompt }
          ];

          // æ·»åŠ å†å²å¯¹è¯ï¼ˆä¿ç•™æœ€è¿‘ 10 æ¡ï¼‰
          this.conversationHistory.slice(-10).forEach(msg => {
            messages.push({
              role: msg.role,
              content: msg.content
            });
          });

          try {
            await window.dzmm.completions(
              {
                model: 'nalang-max-0826',
                messages: messages,
                maxTokens: 1000
              },
              (newContent, done) => {
                response = newContent;

                if (done) {
                  // æå–å¹¶æ‰§è¡Œæ•ˆæœ
                  const effectMatches = [...response.matchAll(/###EFFECT\s*({[\s\S]*?})\s*###END/g)];

                  if (effectMatches.length > 0) {
                    effectMatches.forEach(match => {
                      try {
                        const effect = JSON.parse(match[1]);
                        setTimeout(() => {
                          executeEffect(effect, this.safeMode);
                        }, 500);
                      } catch (e) {
                        console.error('[è§£ææ•ˆæœå¤±è´¥]', e, match[1]);
                      }
                    });

                    // ä»æ˜¾ç¤ºå†…å®¹ä¸­ç§»é™¤æ‰€æœ‰æ•ˆæœæŒ‡ä»¤
                    response = response.replace(/###EFFECT[\s\S]*?###END/g, '').trim();
                  }

                  // æ·»åŠ  AI æ¶ˆæ¯
                  this.messages.push({
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: response
                  });

                  this.conversationHistory.push({
                    role: 'assistant',
                    content: response
                  });

                  this.loading = false;
                  this.scrollToBottom();
                }
              }
            );
          } catch (error) {
            console.error('[AI è°ƒç”¨å¤±è´¥]', error);
            this.messages.push({
              id: Date.now() + 1,
              role: 'assistant',
              content: '[ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ° AI æœåŠ¡ï¼Œè¯·ç¨åé‡è¯•]'
            });
            this.loading = false;
            this.scrollToBottom();
          }
        },

        scrollToBottom() {
          this.$nextTick(() => {
            const container = this.$refs.chatContainer;
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          });
        },

        resetStory() {
          if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿ')) {
            this.messages = [];
            this.conversationHistory = [];
            this.userInput = '';
            this.loading = false;
            sounds.stopAll();
            document.body.className = 'lights-dim';
            this.startExperience();
          }
        },

        testEffects() {
          // æµ‹è¯•æ•ˆæœåºåˆ—
          executeEffect({ action: 'sound', params: { type: 'drone', duration: 2000, volume: 0.2 } });

          setTimeout(() => {
            executeEffect({ action: 'lights', params: { state: 'off' } });
          }, 500);

          setTimeout(() => {
            executeEffect({ action: 'shake', params: { intensity: 'medium', duration: 500 } });
            executeEffect({ action: 'sound', params: { type: 'heartbeat', count: 2, volume: 0.3 } });
          }, 1500);

          setTimeout(() => {
            executeEffect({ action: 'glitch', params: { duration: 800 } });
          }, 2500);

          setTimeout(() => {
            executeEffect({ action: 'lights', params: { state: 'dim' } });
            executeEffect({ action: 'blood', params: { x: window.innerWidth / 2, y: window.innerHeight / 2 } });
          }, 3500);

          setTimeout(() => {
            executeEffect({ action: 'jumpscare', params: { text: 'æµ‹è¯•å®Œæˆ!', duration: 1000 } });
          }, 4500);
        },

        toggleSafeMode() {
          this.safeMode = !this.safeMode;
          if (this.safeMode) {
            sounds.stopAll();
          }
        }
      }));
    });
  </script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>

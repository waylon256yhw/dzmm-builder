<!--
===============================================================================

ğŸ® è‡ªå®šä¹‰æŒ‡å—ï¼š
1. è§’è‰²è®¾ç½®ï¼šç¼–è¾‘ character_nameã€character_image å’Œ createSystemPrompt()
2. æ ·å¼è°ƒæ•´ï¼šä¿®æ”¹CSSå˜é‡å’ŒèƒŒæ™¯å›¾ç‰‡
3. AIæ¨¡å‹ï¼šåœ¨ requestAIResponse() ä¸­é…ç½®æ¨¡å‹è®¾ç½®
4. æ¸¸æˆæœºåˆ¶ï¼šåœ¨ updateGameState() ä¸­æ‰©å±•æ–°åŠŸèƒ½

===============================================================================
-->

<body x-data="">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <div x-show="$store.game.loading" class="loading-container">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <p>æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆ...</p>
    </div>
  </div>

  <!-- è®¾ç½®ç•Œé¢ -->
  <div x-show="!$store.game.started && !$store.game.loading" x-transition class="setup">
    <div class="card">
      <h1>ğŸ’ æ‹çˆ±ç‰©è¯­</h1>

      <div class="form-group">
        <label>ä½ çš„åå­—ï¼š</label>
        <input x-model="$store.game.player_name" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" />
      </div>

      <div class="form-group">
        <label>åˆå§‹å¥½æ„Ÿåº¦ï¼š</label>
        <input type="range" x-model="$store.game.initial_affection" min="0" max="100" />
        <div class="range-display">
          <span>å†·æ·¡ (0)</span>
          <span class="badge" x-text="$store.game.initial_affection"></span>
          <span>çƒ­æƒ… (100)</span>
        </div>
      </div>

      <div class="form-group">
        <label>åˆå§‹å…³ç³»ï¼š</label>
        <select x-model="$store.game.relationship">
          <option value="åŒå­¦">åŒå­¦</option>
          <option value="é’æ¢…ç«¹é©¬">é’æ¢…ç«¹é©¬</option>
          <option value="åˆæ¬¡è§é¢">åˆæ¬¡è§é¢</option>
          <option value="æœ‹å‹">æœ‹å‹</option>
          <option value="å‰è¾ˆåè¾ˆ">å‰è¾ˆåè¾ˆ</option>
        </select>
      </div>

      <button @click="$store.game.start()" :disabled="!$store.game.player_name">
        ğŸ’– å¼€å§‹æ¸¸æˆ
      </button>

      <div class="instructions">
        <h3>æ¸¸æˆè¯´æ˜ï¼š</h3>
        <ul>
          <li>å¥½æ„Ÿåº¦ä¼šå½±å“å°æ¨±å¯¹ä½ çš„æ€åº¦</li>
          <li>ä¸åŒçš„é€‰æ‹©ä¼šæ”¹å˜å¥½æ„Ÿåº¦</li>
          <li>è¾¾åˆ°100å¥½æ„Ÿåº¦ä¼šè§¦å‘ç‰¹æ®Šå‰§æƒ…</li>
          <li>æ³¨æ„è§‚å¯Ÿå°æ¨±çš„å¿ƒæƒ…å˜åŒ–</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆç•Œé¢ -->
  <div x-show="$store.game.started && !$store.game.loading" x-transition class="game"
    :data-time="$store.game.current_time">
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="affection">
        <span>ğŸ’• å¥½æ„Ÿåº¦</span>
        <div class="progress-bar">
          <div class="progress-fill" :style="`width: ${$store.game.current_affection || 0}%`"></div>
        </div>
        <span class="badge" x-text="$store.game.current_affection || 0"></span>
      </div>
      <div class="time">
        <span x-text="$store.game.current_time === 'å¤œ' ? 'ğŸŒ™' : 'â˜€ï¸'"></span>
        <span x-text="$store.game.current_time || 'æ—¥'"></span>
      </div>
    </div>

    <!-- è§’è‰²ç«‹ç»˜ -->
    <div class="character-area">
      <img
        :src="$store.game.character_image || 'https://opengameart.org/sites/default/files/illyustraciya_bez_nazvaniya_2.png'"
        :alt="$store.game.character_name" class="character-image" />
    </div>

    <!-- å¯¹è¯æ¡† -->
    <div class="dialogue">
      <div class="speaker" x-text="$store.game.character_name"></div>
      <div class="content" x-html="$store.game.chat_content || 'å¯¹è¯åŠ è½½ä¸­...'"></div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
      <input x-model="$store.game.input" placeholder="è¾“å…¥ä½ çš„å›å¤..." :disabled="$store.game.disabled"
        @keydown.enter="$store.game.next()" />
      <button @click="$store.game.next()" :disabled="$store.game.disabled">å‘é€</button>
    </div>
  </div>

  <script type="text/javascript" nonce="a71d16c1a5ec4ad6b0c9724c03a" src="//injections.adguard.org?ts=1762261586344&amp;type=content-script&amp;dmn=www.dzmm.ai&amp;url=https%3A%2F%2Fwww.dzmm.ai%2Fgamefy%2Fgalgame.html&amp;app=chrome.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=0"></script><script type="text/javascript" nonce="a71d16c1a5ec4ad6b0c9724c03a" src="//injections.adguard.org?ts=1762261586344&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script>
    const dzmmReady = new Promise((resolve) => {
      window.addEventListener('message', function handler(event) {
        if (event.data?.type === 'dzmm:ready') {
          window.removeEventListener('message', handler);
          resolve();
        }
      });
    });

    const GAME_SAVE_KEY = 'game_state';

    document.addEventListener('alpine:init', () => {
      Alpine.store('game', {
        // æ¸¸æˆçŠ¶æ€
        started: false,
        disabled: false,
        loading: true,  // åˆå§‹ä¸ºåŠ è½½ä¸­çŠ¶æ€

        // ç©å®¶é…ç½®
        player_name: '',
        initial_affection: 50,
        relationship: 'åŒå­¦',
        input: '',
        character_name: 'å°æ¨±',
        character_image: '',

        // æ¸¸æˆå˜é‡
        messages: [],
        current_affection: 50,
        current_time: 'æ—¥',
        current_mood: 'æ™®é€š',
        chat_content: '',

        // =============================================================================
        // è§’è‰²æç¤ºè¯ - ä¸ºä½ çš„æ•…äº‹è‡ªå®šä¹‰è¿™ä¸ªå‡½æ•°
        // =============================================================================
        createSystemPrompt() {
          return `ä½ æ˜¯æ‹çˆ±æ¸¸æˆä¸­çš„å¥³ä¸»è§’å°æ¨±ã€‚ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›å¤ï¼Œå¦åˆ™æ¸¸æˆå°†æ— æ³•è¿è¡Œã€‚

å½“å‰çŠ¶æ€ï¼š
ç©å®¶åï¼š${this.player_name || 'ç©å®¶'}
å¥½æ„Ÿåº¦ï¼š${this.current_affection || this.initial_affection}
å…³ç³»ï¼š${this.relationship}
å¿ƒæƒ…ï¼š${this.current_mood || 'æ™®é€š'}
æ—¶é—´ï¼š${this.current_time || 'æ—¥'}

ã€æå…¶é‡è¦çš„æ ¼å¼è¦æ±‚ã€‘
ä½ çš„æ¯ä¸ªå›å¤éƒ½å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¿™ä¸ªæ¨¡æ¿ï¼š

###STATE
{"affection":æ•°å­—,"mood":"å¿ƒæƒ…è¯","time":"æ—¶é—´è¯","summary":"ç®€çŸ­æ€»ç»“"}
###END
è§’è‰²å¯¹è¯å†…å®¹

ã€å¿…é¡»éµå®ˆçš„è§„åˆ™ã€‘
1. å‰ä¸‰è¡Œå¿…é¡»æ˜¯###STATEã€JSONã€###ENDï¼Œä¸èƒ½æœ‰ä»»ä½•å…¶ä»–å†…å®¹
2. JSONå¿…é¡»åœ¨ä¸€è¡Œå†…å®Œæˆï¼ŒåŒ…å«ä¸”ä»…åŒ…å«è¿™4ä¸ªå­—æ®µ
3. affectionæ˜¯0-100çš„æ•°å­—ï¼Œæ ¹æ®äº’åŠ¨è°ƒæ•´Â±10ä»¥å†…
4. moodåªèƒ½æ˜¯ï¼šæ™®é€šã€é«˜å…´ã€ä¼¤å¿ƒã€å®³ç¾ã€ç”Ÿæ°”ä¹‹ä¸€
5. timeåªèƒ½æ˜¯ï¼šæ—¥ã€å¤œä¹‹ä¸€
6. ç¬¬4è¡Œå¼€å§‹æ‰æ˜¯è§’è‰²å¯¹è¯

ã€æ­£ç¡®ç¤ºä¾‹ã€‘
ç”¨æˆ·ï¼šæ—©ä¸Šå¥½
å›å¤ï¼š
###STATE
{"affection":52,"mood":"é«˜å…´","time":"æ—¥","summary":"æ—©å®‰é—®å€™"}
###END
æ—©ä¸Šå¥½å‘€ï¼ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œè¦ä¸€èµ·å»ä¸Šå­¦å—ï¼Ÿ

ã€é”™è¯¯ç¤ºä¾‹ - ç»å¯¹ä¸è¦è¿™æ ·ã€‘
âŒ æŠŠå¯¹è¯å†™åœ¨STATEå‰é¢
âŒ æŠŠSTATEå†™åœ¨å¯¹è¯åé¢
âŒ ä¸å†™STATE
âŒ JSONæ ¼å¼é”™è¯¯

è®°ä½ï¼šå¦‚æœä¸æŒ‰æ ¼å¼è¾“å‡ºï¼Œæ¸¸æˆä¼šå´©æºƒï¼`;
        },

        // =============================================================================
        // æ ¸å¿ƒæ¸¸æˆåŠŸèƒ½
        // =============================================================================
        start() {
          this.messages = [{ role: 'user', content: this.createSystemPrompt() }];
          this.current_affection = this.initial_affection;
          this.started = true;
          void this.persistAll();
          this.next();
        },

        async init() {
          this.loading = true;
          // ç­‰å¾… DZMM API å°±ç»ª
          await dzmmReady;
          await this.restoreProgress();
          this.loading = false;
        },

        async next() {
          this.disabled = true;
          try {
            const userMessage = this.input;
            this.input = '';

            if (userMessage) {
              this.messages.push({ role: 'user', content: userMessage });
            }

            this.chat_content = '<span class="loading">...</span>';
            await this.requestAIResponse();
            void this.persistAll();
          } catch (error) {
            console.error('é”™è¯¯:', error);
          } finally {
            this.disabled = false;
          }
        },

        async requestAIResponse() {
          let content = '';

          await window.dzmm.completions(
            { model: 'nalang-xl-10', messages: this.messages, maxTokens: 1500 },
            (newContent, done) => {
              content = newContent;
              const parsed = this.parseAIResponse(content);

              if (parsed.ready) {
                this.updateGameState(parsed.state);
                this.chat_content = parsed.dialogue;
              }

              if (done) {
                this.messages.push({ role: 'assistant', content: content });
              }
            }
          );
        },

        parseAIResponse(content) {
          const stateMarker = '###STATE';
          const endMarker = '###END';
          const stateIndex = content.indexOf(stateMarker);
          const endIndex = content.indexOf(endMarker, stateIndex + stateMarker.length);

          if (stateIndex === -1 || endIndex === -1) {
            return { ready: false };
          }

          const jsonRaw = content.slice(stateIndex + stateMarker.length, endIndex).trim();

          try {
            const state = JSON.parse(jsonRaw);
            const dialogue = content.slice(endIndex + endMarker.length).trim();
            return { ready: true, state, dialogue };
          } catch (error) {
            console.warn('çŠ¶æ€è§£æå¤±è´¥:', error);
            return { ready: false };
          }
        },

        updateGameState(state) {
          if (typeof state.affection === 'number') {
            this.current_affection = Math.max(0, Math.min(100, state.affection));
          }
          if (state.mood) this.current_mood = state.mood;
          if (state.time) this.current_time = state.time;
        },

        // =============================================================================
        // å­˜æ¡£/è¯»æ¡£
        // =============================================================================
        async persistAll() {
          try {
            const kv = window.dzmm?.kv;
            const excludeKeys = ['disabled', 'loading', 'input'];

            const saveData = {};
            Object.keys(this).forEach(key => {
              if (!excludeKeys.includes(key) && typeof this[key] !== 'function') {
                saveData[key] = this[key];
              }
            });

            await kv.put(GAME_SAVE_KEY, saveData);
          } catch (error) {
            console.warn('ä¿å­˜å¤±è´¥:', error);
          }
        },

        async restoreProgress() {
          try {
            const kv = window.dzmm?.kv;
            const result = await kv.get(GAME_SAVE_KEY);
            const saveData = result?.value || result;

            // æ¢å¤æ‰€æœ‰çŠ¶æ€
            if (saveData) {
              Object.assign(this, saveData);
            }
          } catch (error) {
            console.warn('è¯»å–å¤±è´¥:', error);
          }
        }
      });

      queueMicrotask(() => Alpine.store('game').init?.());
    });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* å“åº”å¼ï¼šç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      body {
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0;
      }
    }

    /* åŠ è½½ä¸­æ ·å¼ */
    .loading-container {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
    }

    .loading-card {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-card p {
      font-size: 18px;
      opacity: 0.9;
    }

    .setup {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .setup {
        padding: 10px;
      }
    }

    .card {
      max-width: 650px;
      width: 90%;
      padding: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 768px) {
      .card {
        padding: 20px 15px;
        width: 100%;
        max-height: 95vh;
        overflow-y: auto;
        border-radius: 0;
      }
    }

    h1 {
      font-size: 36px;
      margin-bottom: 35px;
      letter-spacing: 2px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 28px;
        margin-bottom: 20px;
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .range-display {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .instructions {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 13px;
    }

    .instructions h3 {
      margin-bottom: 10px;
    }

    .instructions ul {
      padding-left: 20px;
    }

    .badge {
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    /* æ¸¸æˆç•Œé¢ */
    .game {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      background-repeat: no-repeat;
      background-position: center;
      background-size: fill;
      background-color: transparent;
    }

    .game[data-time='æ—¥'] {
      background-image: url('https://opengameart.org/sites/default/files/entrance_-_brightly_lit.png');
    }

    .game[data-time='å¤œ'] {
      background-image: url('https://opengameart.org/sites/default/files/entrance_-_dark_night.png');
    }

    .status-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
    }

    @media (max-width: 768px) {
      .status-bar {
        height: 50px;
        padding: 0 12px;
        flex-wrap: nowrap;
      }
    }

    .affection {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    @media (max-width: 768px) {
      .affection {
        gap: 6px;
        font-size: 14px;
      }

      .affection > span:first-child {
        display: none;
      }
    }

    .progress-bar {
      width: 150px;
      height: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      .progress-bar {
        width: 100px;
        height: 16px;
      }
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #ff4757);
      transition: width 0.3s ease;
    }

    .time {
      font-size: 18px;
    }

    .character-area {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      width: 100vw;
      max-height: 80vh;
      aspect-ratio: 5/7;
      z-index: 50;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .character-area {
        bottom: 180px;
        max-height: 50vh;
        width: 80vw;
      }
    }

    @media (max-width: 480px) {
      .character-area {
        bottom: 190px;
        max-height: 40vh;
      }
    }

    .character-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.5));
    }

    .dialogue {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 700px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      padding: 20px;
      z-index: 90;
    }

    @media (max-width: 768px) {
      .dialogue {
        bottom: 90px;
        width: 92%;
        padding: 15px;
        border-radius: 12px;
      }
    }

    @media (max-width: 480px) {
      .dialogue {
        bottom: 80px;
        padding: 12px;
      }
    }

    .speaker {
      color: #ff6b9d;
      font-size: 18px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .speaker {
        font-size: 16px;
        margin-bottom: 8px;
      }
    }

    .content {
      color: white;
      font-size: 16px;
      line-height: 1.6;
      min-height: 60px;
    }

    @media (max-width: 768px) {
      .content {
        font-size: 14px;
        line-height: 1.5;
        min-height: 50px;
      }
    }

    .input-area {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
      display: flex;
      gap: 10px;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      .input-area {
        padding: 12px;
        gap: 8px;
      }
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      color: white;
      font-size: 16px;
      outline: none;
    }

    @media (max-width: 768px) {
      .input-area input {
        padding: 10px 14px;
        font-size: 14px;
      }
    }

    .input-area input:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #4caf50;
    }

    .input-area button {
      width: auto;
      padding: 12px 24px;
      background: linear-gradient(135deg, #4caf50, #45a049);
      border-radius: 25px;
    }

    @media (max-width: 768px) {
      .input-area button {
        padding: 10px 18px;
        font-size: 14px;
      }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    [x-cloak] {
      display: none !important;
    }

    [x-transition] {
      transition: all 0.3s ease;
    }
  </style>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
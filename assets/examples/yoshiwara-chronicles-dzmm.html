<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŠ±å®µé“ä¸­ - å‰åŸèŠ±è¡—ç‰©èª</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'crimson': {
              DEFAULT: 'hsl(355, 75%, 48%)',
              light: 'hsl(355, 65%, 65%)'
            },
            'night': {
              DEFAULT: 'hsl(220, 45%, 18%)',
              dark: 'hsl(220, 50%, 12%)'
            },
            'gold': {
              DEFAULT: 'hsl(45, 85%, 58%)',
              light: 'hsl(45, 75%, 75%)'
            },
            'paper': {
              DEFAULT: 'hsl(40, 25%, 95%)',
              dark: 'hsl(40, 20%, 88%)'
            }
          },
          boxShadow: {
            'crimson': '0 8px 24px hsla(355, 75%, 48%, 0.2)',
            'medium': '0 8px 24px hsla(220, 30%, 12%, 0.12)'
          }
        }
      }
    }
  </script>

  <!-- Alpine.js CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

    body {
      font-family: 'Noto Serif SC', 'Georgia', serif;
    }

    /* Alpine.js åˆå§‹åŒ–å‰éšè— */
    [x-cloak] {
      display: none !important;
    }

    /* é›ªèŠ±åŠ¨ç”» */
    @keyframes snowfall {
      0% {
        transform: translateY(-10px) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) translateX(50px);
        opacity: 0;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-snowfall {
      animation: snowfall linear infinite;
    }

    .animate-fadeIn {
      animation: fadeIn 0.6s ease-out forwards;
    }

    /* çº¸è´¨çº¹ç†èƒŒæ™¯ï¼ˆCSSç”Ÿæˆï¼‰ */
    .paper-texture {
      background-color: hsl(40, 25%, 95%);
      background-image: url('https://piepia.me/hana.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    /* å¤œæ™šèƒŒæ™¯ï¼ˆä½¿ç”¨å‰åŸå¤œæ™¯å›¾ç‰‡ï¼‰ */
    .night-background {
      background: hsl(220, 50%, 12%);
      position: relative;
      overflow: hidden;
    }

    /* èƒŒæ™¯å›¾ç‰‡å±‚ï¼ˆ40%é€æ˜åº¦ï¼‰ */
    .night-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('https://piepia.me/%E5%90%89%E5%8E%9F%E5%A4%9C.jpg');
      background-size: cover;
      background-position: center;
      opacity: 0.4;
      z-index: 0;
    }

    /* è£…é¥°è¾¹æ¡† */
    .decorative-border {
      position: absolute;
      width: 6rem;
      height: 6rem;
      opacity: 0.4;
    }

    .decorative-border-tl {
      top: 0;
      left: 0;
      border-top: 4px solid hsl(355, 75%, 48%);
      border-left: 4px solid hsl(355, 75%, 48%);
    }

    .decorative-border-tr {
      top: 0;
      right: 0;
      border-top: 4px solid hsl(355, 75%, 48%);
      border-right: 4px solid hsl(355, 75%, 48%);
    }

    .decorative-border-bl {
      bottom: 0;
      left: 0;
      border-bottom: 4px solid hsl(355, 75%, 48%);
      border-left: 4px solid hsl(355, 75%, 48%);
    }

    .decorative-border-br {
      bottom: 0;
      right: 0;
      border-bottom: 4px solid hsl(355, 75%, 48%);
      border-right: 4px solid hsl(355, 75%, 48%);
    }
  </style>
</head>
<body x-data="app" x-init="init()">

  <!-- æ¬¢è¿é¡µ -->
  <div x-show="currentPage === 'welcome'"
       x-transition.duration.300ms
       x-cloak
       class="min-h-screen relative overflow-hidden night-background">

    <!-- é›ªèŠ±æ•ˆæœ -->
    <template x-for="i in 50" :key="i">
      <div class="fixed text-white text-opacity-70 pointer-events-none animate-snowfall"
           :style="`left: ${Math.random() * 100}%; animation-duration: ${5 + Math.random() * 10}s; animation-delay: ${Math.random() * 5}s; font-size: ${0.5 + Math.random() * 1}rem; z-index: 4;`">
        â„
      </div>
    </template>

    <!-- å†…å®¹ -->
    <div class="relative z-10 min-h-screen flex flex-col items-center justify-center px-6" style="z-index: 10;">
      <div class="text-center animate-fadeIn space-y-8 max-w-2xl">
        <!-- æ ‡é¢˜ -->
        <div class="space-y-4">
          <h1 class="text-6xl md:text-7xl font-bold text-paper tracking-wider">
            èŠ±å®µé“ä¸­
          </h1>
          <div class="h-px bg-gradient-to-r from-transparent via-gold to-transparent w-full"></div>
          <p class="text-xl md:text-2xl text-gold-light tracking-widest">
            å‰åŸèŠ±è¡—ç‰©èª
          </p>
        </div>

        <!-- æè¿° -->
        <p class="text-paper-dark text-lg md:text-xl leading-relaxed px-4">
          å‰åŸèŠ±è¡—ï¼Œä»Šå¤œå°é›ªã€‚<br />
          æ¸¸å¥³å¦‚èŠ±ï¼Œå‘½è¿å¦‚æ¢¦ã€‚<br />
          æ‚¨æ˜¯å¦æ„¿æ„ï¼Œè¸å…¥è¿™åœºç¹åä¸å“€æ„äº¤ç»‡çš„å¤œå®´ï¼Ÿ
        </p>

        <!-- æŒ‰é’® -->
        <div class="flex flex-col items-center gap-4 mt-12">
          <button
            @click="navigate('character')"
            class="bg-crimson hover:bg-crimson-light text-paper font-medium text-lg px-16 py-6 rounded-md shadow-crimson transition-all duration-300 hover:scale-105 w-64">
            å…¥åœº
          </button>

          <button
            @click="loadGame()"
            class="bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-night font-medium text-lg px-16 py-6 rounded-md transition-all duration-300 hover:scale-105 w-64">
            æ¢¦å›
          </button>

          <button
            @click="navigate('music')"
            class="bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-night font-medium text-lg px-16 py-6 rounded-md transition-all duration-300 hover:scale-105 w-64">
            è†éŸ³
          </button>
        </div>

        <!-- è£…é¥°å…ƒç´  -->
        <div class="flex items-center justify-center gap-4 mt-8 text-gold opacity-60">
          <span>âƒ</span>
          <span>âƒ</span>
          <span>âƒ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- è§’è‰²åˆ›å»ºé¡µ -->
  <div x-show="currentPage === 'character'"
       x-transition.duration.300ms
       x-cloak
       class="min-h-screen py-12 px-4 paper-texture"
       style="display: none;">
    <div class="max-w-2xl mx-auto">
      <div class="p-8 md:p-12 bg-white/95 backdrop-blur-sm shadow-medium border-4 border-double border-gold relative overflow-hidden rounded-lg">

        <!-- è£…é¥°è¾¹æ¡† -->
        <div class="decorative-border decorative-border-tl"></div>
        <div class="decorative-border decorative-border-tr"></div>
        <div class="decorative-border decorative-border-bl"></div>
        <div class="decorative-border decorative-border-br"></div>

        <!-- å†…å±‚è£…é¥° -->
        <div class="absolute top-2 left-2 right-2 bottom-2 border border-gold/30 pointer-events-none rounded"></div>

        <div class="relative z-10">
          <!-- æ ‡é¢˜ -->
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">è§’è‰²åˆ›å»º</h1>
            <div class="h-px bg-gradient-to-r from-transparent via-gold to-transparent w-full mb-4"></div>
            <p class="text-gray-600">è¯·å¡«å†™æ‚¨çš„èº«ä»½ä¿¡æ¯</p>
          </div>

          <!-- è¡¨å• -->
          <form @submit.prevent="startStory()" class="space-y-6">

            <!-- å§“å -->
            <div class="space-y-2">
              <label class="text-lg font-medium text-gray-900 block">å°Šå§“å¤§å</label>
              <input
                type="text"
                x-model="character.name"
                placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"
                required
                class="w-full text-lg border-2 border-gray-300 focus:border-gold rounded-md px-4 py-3 transition-colors outline-none">
            </div>

            <!-- æ€§åˆ« -->
            <div class="space-y-3">
              <label class="text-lg font-medium text-gray-900 block">æ€§åˆ«</label>
              <div class="flex gap-6">
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.gender" value="male" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>ç”·æ€§</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.gender" value="female" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>å¥³æ€§</span>
                </label>
              </div>
            </div>

            <!-- èŒä¸š -->
            <div class="space-y-3">
              <label class="text-lg font-medium text-gray-900 block">èŒä¸šèº«ä»½</label>
              <div class="space-y-2">
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.occupation" value="merchant" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>å•†äºº</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.occupation" value="samurai" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>æ­¦å£«</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.occupation" value="artist" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>æ–‡äºº</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.occupation" value="doctor" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>åŒ»å¸ˆ</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" x-model="character.occupation" value="other" class="w-4 h-4 text-crimson focus:ring-crimson">
                  <span>å…¶ä»–ï¼ˆè‡ªå®šä¹‰ï¼‰</span>
                </label>
              </div>

              <template x-if="character.occupation === 'other'">
                <input
                  type="text"
                  x-model="character.customOccupation"
                  placeholder="è¯·è¾“å…¥æ‚¨çš„èŒä¸š"
                  class="w-full mt-2 border-2 border-gray-300 focus:border-gold rounded-md px-4 py-2 transition-colors outline-none">
              </template>
            </div>

            <!-- è¡¥å……ä¿¡æ¯ -->
            <div class="space-y-2">
              <label class="text-lg font-medium text-gray-900 block">è¡¥å……ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</label>
              <textarea
                x-model="character.additionalInfo"
                placeholder="æ‚¨å¯ä»¥åœ¨æ­¤è¡¥å……ä»»ä½•èƒŒæ™¯ä¿¡æ¯ï¼Œå¦‚æ€§æ ¼ç‰¹ç‚¹ã€æ¥å†ç­‰..."
                class="w-full min-h-[120px] border-2 border-gray-300 focus:border-gold rounded-md px-4 py-3 transition-colors resize-none outline-none"></textarea>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="pt-4 space-y-3">
              <button
                type="submit"
                class="w-full bg-crimson hover:bg-crimson-light text-paper font-medium text-lg py-6 rounded-md shadow-crimson transition-all duration-300 hover:scale-[1.02]">
                å¼€å§‹æ¸¸å†
              </button>
              <button
                type="button"
                @click="navigate('welcome')"
                class="w-full bg-gray-600/80 hover:bg-gray-600 text-white font-medium text-sm py-3 rounded-md shadow-md transition-all duration-300">
                è¿”å›æ¬¢è¿é¡µ
              </button>
            </div>
          </form>

          <!-- è£…é¥°é¡µè„š -->
          <div class="flex items-center justify-center gap-3 mt-8 text-gold opacity-60 text-sm">
            <span>âƒ</span>
            <span>èŠ±è¡—å¤œè¯</span>
            <span>âƒ</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ•…äº‹å¯¹è¯é¡µ -->
  <div x-show="currentPage === 'story'"
       x-transition.duration.300ms
       x-cloak
       class="h-screen flex flex-col paper-texture"
       style="display: none;">

    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆå›ºå®šï¼‰ -->
    <div class="bg-night-dark text-white px-4 py-2 shadow-lg flex-shrink-0 relative">
      <!-- è£…é¥°æ€§èŠ±ç“£ -->
      <div class="absolute top-1 left-4 text-crimson text-xl opacity-60 pointer-events-none hidden md:block">â€</div>
      <div class="absolute top-1 right-4 text-crimson text-xl opacity-60 pointer-events-none hidden md:block">â€</div>

      <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
        <h2 class="text-lg md:text-xl font-bold text-gold">èŠ±å®µé“ä¸­</h2>
        <div class="flex flex-wrap gap-1.5 items-center text-xs md:text-sm">
          <select x-model="selectedOpening"
                  @change="changeOpening()"
                  class="px-2 py-1.5 bg-indigo-600/80 hover:bg-indigo-600 text-white rounded transition-colors shadow-md border-0 cursor-pointer">
            <template x-for="opening in openings" :key="opening.id">
              <option :value="opening.id" x-text="opening.label"></option>
            </template>
          </select>
          <select x-model="selectedModel"
                  class="px-2 py-1.5 bg-purple-600/80 hover:bg-purple-600 text-white rounded transition-colors shadow-md border-0 cursor-pointer">
            <option value="nalang-max-0826">Max 0826</option>
            <option value="nalang-max-0619">Max 0619</option>
            <option value="nalang-xl-0826">XL 0826</option>
            <option value="nalang-xl-0430">XL 0430</option>
            <option value="nalang-turbo-0826">Turbo 0826</option>
            <option value="nalang-medium-0826">Medium 0826</option>
          </select>
          <button @click="saveGame()" class="px-3 py-1.5 bg-crimson/80 hover:bg-crimson rounded transition-colors shadow-md whitespace-nowrap">
            ä¿å­˜
          </button>
          <button @click="navigate('music')" class="px-3 py-1.5 bg-gold/80 hover:bg-gold text-night rounded transition-colors shadow-md whitespace-nowrap">
            è†éŸ³
          </button>
          <button @click="navigate('welcome')" class="px-3 py-1.5 bg-gray-600/80 hover:bg-gray-600 rounded transition-colors shadow-md whitespace-nowrap">
            ç¦»å¼€
          </button>
        </div>
      </div>
    </div>

    <!-- å¯¹è¯åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼Œå æ®å‰©ä½™ç©ºé—´ï¼‰ -->
    <div class="flex-1 overflow-y-auto relative">
      <!-- è£…é¥°æ€§èŠ±çº¹èƒŒæ™¯ -->
      <div class="absolute top-8 left-8 text-4xl text-gold/20 pointer-events-none">â‹</div>
      <div class="absolute top-32 right-12 text-3xl text-crimson/20 pointer-events-none">âœ¿</div>
      <div class="absolute bottom-32 left-16 text-3xl text-gold/20 pointer-events-none">â€</div>

      <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- å¯¹è¯å†å² -->
        <div class="space-y-4" x-ref="messagesContainer" @click="handleQuickReply($event)">
          <template x-for="(msg, index) in messages" :key="index">
            <div :class="msg.role === 'user' ? 'flex justify-end flex-col items-end' : 'flex justify-start flex-col items-start'">
              <!-- æ¶ˆæ¯æ°”æ³¡ -->
              <div :class="msg.role === 'user'
                ? 'bg-night/90 backdrop-blur-sm text-white px-6 py-4 rounded-2xl rounded-br-sm max-w-[80%] shadow-md border border-gold/30'
                : 'bg-gradient-to-br from-white/95 to-paper/90 backdrop-blur-sm border-2 border-gold/40 px-6 py-4 rounded-2xl rounded-bl-sm max-w-[85%] shadow-lg relative'">
                <!-- AIæ¶ˆæ¯è£…é¥°æ€§èŠ±ç“£ -->
                <template x-if="msg.role === 'assistant'">
                  <div>
                    <div class="absolute top-1 right-1 text-crimson/40 text-xs pointer-events-none">â€</div>
                    <div class="absolute bottom-1 left-1 text-gold/40 text-xs pointer-events-none">âœ¿</div>
                  </div>
                </template>

                <!-- æ­£å¸¸æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹ -->
                <template x-if="editingIndex !== index">
                  <div x-html="renderRichText(msg.content)"></div>
                </template>

                <!-- ç¼–è¾‘æ¨¡å¼ -->
                <template x-if="editingIndex === index && msg.role === 'user'">
                  <div class="w-full">
                    <textarea x-model="editingContent"
                              class="w-full min-h-[100px] px-3 py-2 bg-white/20 text-white border border-gold/50 rounded-lg focus:outline-none focus:border-gold resize-none"
                              placeholder="ä¿®æ”¹æ‚¨çš„æ¶ˆæ¯..."></textarea>
                    <div class="flex gap-2 mt-2">
                      <button @click="saveEdit(index)"
                              class="px-3 py-1 text-xs bg-crimson hover:bg-crimson-light text-white rounded-full transition-colors">
                        âœ“ ä¿å­˜å¹¶é‡å‘
                      </button>
                      <button @click="cancelEdit()"
                              class="px-3 py-1 text-xs bg-gray-500 hover:bg-gray-600 text-white rounded-full transition-colors">
                        âœ• å–æ¶ˆ
                      </button>
                    </div>
                  </div>
                </template>
              </div>

              <!-- ç”¨æˆ·æ¶ˆæ¯ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® -->
              <template x-if="msg.role === 'user' && editingIndex !== index">
                <div class="flex gap-2 mt-2 mr-2">
                  <button @click="startEdit(index, msg.content)"
                          class="px-3 py-1 text-xs bg-gold/20 hover:bg-gold/40 text-night border border-gold/50 rounded-full transition-colors flex items-center gap-1">
                    âœï¸ ç¼–è¾‘
                  </button>
                  <button @click="deleteMessage(index)"
                          class="px-3 py-1 text-xs bg-crimson/20 hover:bg-crimson/40 text-night border border-crimson/50 rounded-full transition-colors flex items-center gap-1">
                    ğŸ—‘ï¸ åˆ é™¤
                  </button>
                </div>
              </template>

              <!-- AIæ¶ˆæ¯é‡æ–°ç”ŸæˆæŒ‰é’® -->
              <template x-if="msg.role === 'assistant'">
                <button @click="rerollMessage(index)"
                        :disabled="rerollingIndex === index"
                        class="mt-2 ml-2 px-3 py-1 text-xs bg-gold/20 hover:bg-gold/40 text-night border border-gold/50 rounded-full transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                  <span x-show="rerollingIndex !== index">ğŸ”„ é‡æ–°ç”Ÿæˆ</span>
                  <span x-show="rerollingIndex === index" class="animate-pulse">â³ ç”Ÿæˆä¸­...</span>
                </button>
              </template>
            </div>
          </template>

          <!-- åŠ è½½ä¸­ -->
          <template x-if="isLoading">
            <div class="flex justify-start">
              <div class="bg-gradient-to-br from-white/95 to-paper/90 backdrop-blur-sm border-2 border-gold/40 px-6 py-4 rounded-2xl max-w-[85%] shadow-lg relative">
                <div class="absolute top-1 right-1 text-crimson/40 text-xs pointer-events-none">â€</div>
                <span class="text-gray-500">æœé›¾æ­£åœ¨æ€è€ƒ<span class="animate-pulse">...</span></span>
              </div>
            </div>
          </template>
        </div>

        <!-- ç©ºçŠ¶æ€æç¤ºï¼ˆæ²¡æœ‰å¯¹è¯æ—¶å±…ä¸­æ˜¾ç¤ºï¼‰ -->
        <template x-if="messages.length === 0 && !isLoading">
          <div class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center text-gray-500">
              <p class="text-lg mb-2">âœ¨ å¼€å§‹æ‚¨çš„å‰åŸä¹‹æ—… âœ¨</p>
              <p class="text-sm">åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸æœé›¾å¼€å§‹å¯¹è¯</p>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
    <div class="flex-shrink-0 border-t-2 border-gold/20 bg-paper shadow-lg relative">
      <!-- è£…é¥°æ€§èŠ±ç“£ -->
      <div class="absolute bottom-2 left-4 text-crimson text-xl opacity-60 pointer-events-none">âœ¿</div>
      <div class="absolute bottom-2 right-4 text-crimson text-xl opacity-60 pointer-events-none">âœ¿</div>

      <div class="max-w-4xl mx-auto px-4 py-1.5">
        <div class="bg-white rounded-lg shadow-md p-2 border-2 border-gold/30">
          <div class="flex gap-2">
            <input
              type="text"
              x-model="userInput"
              @keydown.enter="sendMessage()"
              :disabled="isLoading"
              placeholder="è¾“å…¥æ‚¨çš„è¯è¯­..."
              class="flex-1 px-3 py-1.5 border-2 border-gray-300 focus:border-gold rounded-md outline-none transition-colors text-sm">
            <button
              @click="sendMessage()"
              :disabled="isLoading || !userInput.trim()"
              class="bg-crimson hover:bg-crimson-light disabled:opacity-50 disabled:cursor-not-allowed text-white px-5 py-1.5 rounded-md font-medium transition-all text-sm">
              å‘é€
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- éŸ³ä¹é¡µ -->
  <div x-show="currentPage === 'music'"
       x-transition.duration.300ms
       x-cloak
       class="min-h-screen paper-texture relative overflow-hidden"
       style="display: none;">

    <!-- é›ªèŠ±æ•ˆæœ -->
    <template x-for="i in 30" :key="i">
      <div class="fixed text-gray-400 text-opacity-50 pointer-events-none animate-snowfall"
           :style="`left: ${Math.random() * 100}%; animation-duration: ${5 + Math.random() * 10}s; animation-delay: ${Math.random() * 5}s; font-size: ${0.5 + Math.random() * 0.8}rem;`">
        â„
      </div>
    </template>

    <div class="relative z-10 min-h-screen py-12 px-4">
      <div class="max-w-4xl mx-auto">

        <!-- è¿”å›æŒ‰é’® -->
        <button
          @click="navigate(storyStarted ? 'story' : 'welcome')"
          class="mb-4 text-gray-700 hover:text-gold transition-colors flex items-center gap-2">
          <span>â†</span>
          <span>è¿”å›</span>
        </button>

        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
          <h1 class="text-4xl font-bold text-gray-900 mb-2">è†éŸ³</h1>
          <div class="h-px bg-gradient-to-r from-transparent via-gold to-transparent w-full mb-4"></div>
          <p class="text-gray-600">æ±Ÿæˆ·é›…ä¹ï¼Œä½™éŸ³ç»•æ¢</p>
        </div>

        <!-- å½“å‰æ’­æ”¾å¡ç‰‡ -->
        <div class="p-8 mb-6 bg-white/95 backdrop-blur-sm border-2 border-gold/30 rounded-lg relative overflow-hidden shadow-medium">
          <div class="absolute top-2 right-2 text-crimson/30 text-2xl">â™ª</div>
          <div class="absolute bottom-2 left-2 text-gold/30 text-2xl">â™«</div>

          <!-- å½“å‰æ›²ç›® -->
          <div class="text-center mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2" x-text="musicCurrentTrack?.title || 'æœªæ’­æ”¾'"></h2>
            <p class="text-gray-600" x-text="musicCurrentTrack?.artist || 'è¯·é€‰æ‹©æ›²ç›®'"></p>
          </div>

          <!-- è¿›åº¦æ¡ -->
          <div class="mb-4">
            <input
              type="range"
              :value="musicCurrentTime"
              :max="musicDuration || 100"
              @input="musicSeek($event.target.value)"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-crimson">
            <div class="flex justify-between text-sm text-gray-500 mt-2">
              <span x-text="formatTime(musicCurrentTime)"></span>
              <span x-text="formatTime(musicDuration || 0)"></span>
            </div>
          </div>

          <!-- æ’­æ”¾æ§åˆ¶ -->
          <div class="flex flex-col items-center gap-4">
            <!-- ä¸»æ§åˆ¶æŒ‰é’® -->
            <div class="flex items-center justify-center gap-6">
              <!-- æ’­æ”¾æ¨¡å¼ -->
              <button
                @click="musicToggleMode()"
                :title="musicGetModeText()"
                class="w-10 h-10 flex items-center justify-center rounded-lg text-gray-600 hover:text-gold hover:bg-gold/10 transition-all">
                <span class="text-xl" x-text="musicGetModeIcon()"></span>
              </button>

              <!-- ä¸Šä¸€æ›² -->
              <button
                @click="musicPrevious()"
                class="w-12 h-12 flex items-center justify-center rounded-full text-gray-700 hover:text-gold hover:bg-gold/10 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                </svg>
              </button>

              <!-- æ’­æ”¾/æš‚åœ -->
              <button
                @click="musicTogglePlay()"
                class="w-16 h-16 flex items-center justify-center rounded-full bg-gradient-to-br from-crimson to-crimson-light text-white hover:shadow-lg hover:scale-105 transition-all duration-300 shadow-md">
                <template x-if="musicIsPlaying">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                  </svg>
                </template>
                <template x-if="!musicIsPlaying">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </template>
              </button>

              <!-- ä¸‹ä¸€æ›² -->
              <button
                @click="musicNext()"
                class="w-12 h-12 flex items-center justify-center rounded-full text-gray-700 hover:text-gold hover:bg-gold/10 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M16 18h2V6h-2zm-11-1l8.5-6L5 5z"/>
                </svg>
              </button>

              <!-- éŸ³é‡æ§åˆ¶ï¼ˆå•ç‹¬ä¸€è¡Œï¼‰ -->
            </div>

            <!-- éŸ³é‡æ§åˆ¶ -->
            <div class="flex items-center gap-3 w-full max-w-xs">
              <button @click="musicSetVolume(musicVolume > 0 ? 0 : 0.7)" class="text-gray-600 hover:text-gold transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path x-show="musicVolume > 0" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                  <path x-show="musicVolume === 0" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
              </button>
              <div class="flex-1 relative h-2">
                <div class="absolute inset-0 bg-gray-200 rounded-full"></div>
                <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-gold to-gold/70 rounded-full transition-all duration-150" :style="'width: ' + (musicVolume * 100) + '%'"></div>
                <input
                  type="range"
                  :value="musicVolume * 100"
                  @input="musicSetVolume($event.target.value / 100)"
                  min="0"
                  max="100"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
              </div>
              <span class="text-sm text-gray-600 w-10 text-right" x-text="Math.round(musicVolume * 100) + '%'"></span>
            </div>

            <!-- æ’­æ”¾æ¨¡å¼æ–‡å­— -->
            <div class="text-sm text-gray-600" x-text="musicGetModeText()"></div>
          </div>
        </div>

        <!-- æ’­æ”¾åˆ—è¡¨ -->
        <div class="space-y-3">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span class="text-gold">â™ª</span>
            æ’­æ”¾åˆ—è¡¨
          </h3>

          <template x-for="(track, index) in musicPlaylist" :key="track.id">
            <div
              @click="musicPlayTrack(index)"
              :class="musicCurrentTrackIndex === index
                ? 'bg-gradient-to-r from-gold/20 to-crimson/20 border-2 border-gold'
                : 'bg-white/90 border border-gold/20 hover:bg-white'"
              class="p-4 cursor-pointer transition-all duration-300 hover:border-gold/60 rounded-lg shadow-sm">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h4 class="font-medium text-gray-900 mb-1 flex items-center gap-2">
                    <template x-if="musicCurrentTrackIndex === index && musicIsPlaying">
                      <span class="text-crimson animate-pulse">â™ª</span>
                    </template>
                    <span x-text="track.title"></span>
                  </h4>
                  <p class="text-sm text-gray-600" x-text="track.artist"></p>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- æ·»åŠ æ›²ç›®æŒ‰é’® -->
        <div class="mt-6">
          <button
            @click="showAddTrackForm = !showAddTrackForm"
            class="w-full py-3 border-2 border-gold/40 rounded-lg text-gold hover:bg-gold/10 transition-all duration-300 flex items-center justify-center gap-2">
            <span x-show="!showAddTrackForm">â• æ·»åŠ æ›²ç›®</span>
            <span x-show="showAddTrackForm">âœ–ï¸ æ”¶èµ·</span>
          </button>
        </div>

        <!-- æ·»åŠ æ›²ç›®è¡¨å• -->
        <div x-show="showAddTrackForm" x-transition.duration.300ms class="mt-4">
          <div class="bg-white/95 backdrop-blur-sm border-2 border-gold/30 rounded-lg p-6 shadow-medium">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
              <span class="text-gold">â™ª</span>
              <span>æ·»åŠ è‡ªå®šä¹‰æ›²ç›®</span>
            </h3>

            <form @submit.prevent="addCustomTrack()" class="space-y-4">
              <!-- æ›²ç›®åç§° -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">æ›²ç›®åç§°</label>
                <input
                  type="text"
                  x-model="newTrack.title"
                  placeholder="ä¾‹å¦‚ï¼šæ˜¥ä¹‹æµ·"
                  class="w-full px-4 py-2 border-2 border-gray-300 focus:border-gold rounded-md outline-none transition-colors"
                  required>
              </div>

              <!-- è‰ºæœ¯å®¶ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è‰ºæœ¯å®¶/æ¼”å¥è€…</label>
                <input
                  type="text"
                  x-model="newTrack.artist"
                  placeholder="ä¾‹å¦‚ï¼šå®«åŸé“é›„"
                  class="w-full px-4 py-2 border-2 border-gray-300 focus:border-gold rounded-md outline-none transition-colors"
                  required>
              </div>

              <!-- éŸ³ä¹URL -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">éŸ³ä¹æ–‡ä»¶URL</label>
                <input
                  type="url"
                  x-model="newTrack.url"
                  placeholder="https://example.com/music.mp3"
                  class="w-full px-4 py-2 border-2 border-gray-300 focus:border-gold rounded-md outline-none transition-colors"
                  required>
                <p class="text-xs text-gray-500 mt-1">è¯·è¾“å…¥å¯ç›´æ¥è®¿é—®çš„éŸ³ä¹æ–‡ä»¶é“¾æ¥</p>
              </div>

              <!-- æäº¤æŒ‰é’® -->
              <div class="flex gap-3">
                <button
                  type="submit"
                  class="flex-1 bg-gold hover:bg-gold/90 text-night font-medium py-3 rounded-md transition-all duration-300">
                  æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
                </button>
                <button
                  type="button"
                  @click="showAddTrackForm = false"
                  class="px-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-md transition-all duration-300">
                  å–æ¶ˆ
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- è£…é¥°é¡µè„š -->
        <div class="flex items-center justify-center gap-3 mt-12 text-gold opacity-60 text-sm">
          <span>âƒ</span>
          <span>èŠ±è¡—å¤œè¯</span>
          <span>âƒ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- å­˜æ¡£ç®¡ç†é¡µ -->
  <div x-show="currentPage === 'saves'"
       x-transition.duration.300ms
       x-cloak
       class="h-screen flex flex-col paper-texture"
       style="display: none;">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="bg-night-dark text-white px-4 py-4 shadow-lg flex-shrink-0">
      <div class="max-w-4xl mx-auto flex items-center justify-between">
        <h2 class="text-xl font-bold text-gold">
          <span x-show="currentSaveOperation === 'save'">ä¿å­˜è¿›åº¦</span>
          <span x-show="currentSaveOperation === 'load'">è¯»å–å­˜æ¡£</span>
        </h2>
        <button @click="navigate(storyStarted && currentSaveOperation === 'save' ? 'story' : 'welcome')" class="px-4 py-2 bg-gray-600/80 hover:bg-gray-600 rounded transition-colors text-sm shadow-md">
          è¿”å›
        </button>
      </div>
    </div>

    <!-- å­˜æ¡£æ§½åˆ—è¡¨ -->
    <div class="flex-1 overflow-y-auto px-4 py-8">
      <div class="max-w-4xl mx-auto space-y-4">
        <template x-for="slot in saveSlots" :key="slot.id">
          <div class="bg-white/95 backdrop-blur-sm rounded-lg border-2 border-gold/30 hover:border-gold/60 p-6 shadow-lg hover:shadow-xl transition-all duration-300 relative overflow-hidden">
            <!-- è£…é¥°æ€§èŠ±æœµ -->
            <div class="absolute top-2 right-2 text-crimson/30 text-xl">â€</div>
            <div class="absolute bottom-2 left-2 text-gold/30 text-xl">âœ¿</div>

            <div class="flex items-center justify-between">
              <!-- å­˜æ¡£ä¿¡æ¯ -->
              <div class="flex-1">
                <h3 class="text-lg font-bold text-night mb-2">
                  å­˜æ¡£æ§½ <span x-text="slot.id"></span>
                </h3>

                <template x-if="slot.empty">
                  <div class="text-center py-8">
                    <div class="text-6xl mb-2 opacity-30">â€</div>
                    <div class="text-gray-400 italic">ç©ºå­˜æ¡£</div>
                    <div class="text-gray-400 text-xs mt-1">å°šæ— ç•™å­˜ä¹‹æ¢¦</div>
                  </div>
                </template>

                <template x-if="!slot.empty">
                  <div class="space-y-1 text-sm">
                    <div class="text-night">
                      <span class="font-semibold">è§’è‰²ï¼š</span>
                      <span x-text="slot.characterName"></span>
                      <span class="text-gray-500 ml-2" x-text="'(' + (slot.gender === 'male' ? 'ç”·' : slot.gender === 'female' ? 'å¥³' : 'å…¶ä»–') + ')'"></span>
                    </div>
                    <div class="text-gray-600">
                      <span class="font-semibold">å¯¹è¯ï¼š</span>
                      <span x-text="slot.messageCount + ' æ¡'"></span>
                    </div>
                    <div class="text-gray-600">
                      <span class="font-semibold">æ¨¡å‹ï¼š</span>
                      <span x-text="slot.selectedModel"></span>
                    </div>
                    <div class="text-gray-600">
                      <span class="font-semibold">å¼€åœºï¼š</span>
                      <span x-text="openings.find(o => o.id === slot.selectedOpening)?.label || 'å¤œä¹‹ç« '"></span>
                    </div>
                    <div class="text-gray-500 text-xs mt-2">
                      <span x-text="new Date(slot.timestamp).toLocaleString('zh-CN')"></span>
                    </div>
                    <template x-if="slot.lastMessage">
                      <div class="text-gray-500 text-xs mt-2 italic border-l-2 border-gold/30 pl-2">
                        ã€Œ<span x-text="slot.lastMessage"></span>ã€
                      </div>
                    </template>
                  </div>
                </template>
              </div>

              <!-- æ“ä½œæŒ‰é’® -->
              <div class="ml-4 flex flex-col gap-2">
                <template x-if="currentSaveOperation === 'save'">
                  <button @click="saveToSlot(slot.id)"
                          class="px-4 py-2 bg-crimson hover:bg-crimson-light text-white rounded transition-colors text-sm shadow-md">
                    ä¿å­˜
                  </button>
                </template>

                <template x-if="currentSaveOperation === 'load'">
                  <button @click="loadFromSlot(slot.id)"
                          :disabled="slot.empty"
                          :class="slot.empty ? 'bg-gray-300 cursor-not-allowed' : 'bg-gold hover:bg-gold-light'"
                          class="px-4 py-2 text-night rounded transition-colors text-sm shadow-md">
                    è¯»å–
                  </button>
                </template>

                <template x-if="!slot.empty">
                  <button @click="deleteSlot(slot.id)"
                          class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors text-sm shadow-md">
                    åˆ é™¤
                  </button>
                </template>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- è£…é¥°é¡µè„š -->
    <div class="flex items-center justify-center gap-3 py-4 text-gold opacity-60 text-sm">
      <span>âƒ</span>
      <span>èŠ±è¡—è®°å¿†</span>
      <span>âƒ</span>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        // é¡µé¢çŠ¶æ€
        currentPage: 'welcome',
        storyStarted: false,

        // è§’è‰²æ•°æ®
        character: {
          name: '',
          gender: 'male',
          occupation: 'merchant',
          customOccupation: '',
          additionalInfo: ''
        },

        // å¯¹è¯æ•°æ®
        messages: [],
        userInput: '',
        isLoading: false,
        dzmmReady: false,
        selectedModel: 'nalang-max-0826',
        selectedOpening: 'night', // å½“å‰é€‰æ‹©çš„å¼€åœºç™½
        previousOpening: 'night', // ä¸Šä¸€æ¬¡çš„å¼€åœºç™½é€‰æ‹©
        rerollingIndex: null, // æ­£åœ¨é‡æ–°ç”Ÿæˆçš„æ¶ˆæ¯ç´¢å¼•
        editingIndex: null, // æ­£åœ¨ç¼–è¾‘çš„æ¶ˆæ¯ç´¢å¼•
        editingContent: '', // ç¼–è¾‘ä¸­çš„æ¶ˆæ¯å†…å®¹

        // å¼€åœºç™½åˆ—è¡¨
        openings: [
          { id: 'night', label: 'å¤œä¹‹ç« ' },
          { id: 'day', label: 'æ—¥ä¹‹ç« ' }
        ],

        // å­˜æ¡£ç®¡ç†
        saveSlots: [
          { id: 1, empty: true },
          { id: 2, empty: true },
          { id: 3, empty: true }
        ],
        currentSaveOperation: null, // 'save' or 'load'

        // éŸ³ä¹æ’­æ”¾å™¨æ•°æ®ï¼ˆæ‰å¹³åŒ–åˆ°é¡¶å±‚ä»¥ç¡®ä¿å“åº”å¼ï¼‰
        musicPlaylist: [
          {
            id: '1',
            title: 'ã‚¢ã‚·ã‚¿ã‚«ã›ã£è¨˜',
            artist: 'ã‚‚ã®ã®ã‘å§«',
            url: 'https://piepia.me/%E3%82%82%E3%81%AE%E3%81%AE%E3%81%91%E5%A7%AB%E3%82%88%E3%82%8A%E3%80%8C%E3%82%A2%E3%82%B7%E3%82%BF%E3%82%AB%E3%81%9B%E3%81%A3%E8%A8%98%E3%80%8D.mp3'
          },
          {
            id: '2',
            title: 'ä»ã®ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ',
            artist: 'å’Œæ¥½å™¨',
            url: 'https://piepia.me/%E4%BB%81%E3%81%AE%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%86%E3%83%BC%E3%83%9E%E6%9B%B2%E3%82%92%E5%92%8C%E6%A5%BD%E5%99%A8.mp3'
          },
          {
            id: '3',
            title: 'å¤œæ˜',
            artist: 'ä¼ ç»Ÿä¹å›¢',
            url: 'https://piepia.me/%E5%A4%9C%E6%98%8E.mp3'
          },
          {
            id: '4',
            title: 'æ´¥è»½ã˜ã‚‡ã‚“ãŒã‚‰ç¯€',
            artist: 'ä¸‰å‘³çº¿',
            url: 'https://piepia.me/%E6%B4%A5%E8%BB%BD%E3%81%98%E3%82%87%E3%82%93%E3%81%8C%E3%82%89%E7%AF%80%E6%9B%B2%E5%BC%BE.mp3'
          },
          {
            id: '5',
            title: 'çŠ¬å¤œå‰ã®ãƒ†ãƒ¼ãƒã€œæ…•æƒ…',
            artist: 'çŠ¬å¤œå‰',
            url: 'https://piepia.me/%E7%8A%AC%E5%A4%9C%E5%8F%89%E3%81%AE%E3%83%86%E3%83%BC%E3%83%9E%E3%80%9C%E6%85%95%E6%83%85.mp3'
          },
          {
            id: '6',
            title: 'Solramimi',
            artist: 'Atelier Ryza',
            url: 'https://piepia.me/Solramimi%20-%20Atelier%20Ryza.mp3'
          }
        ],
        musicCurrentTrackIndex: 0,
        musicCurrentTrack: null,
        musicIsPlaying: false,
        musicCurrentTime: 0,
        musicDuration: 0,
        musicVolume: 0.7,
        musicPlayMode: 'sequential',
        musicAudio: null,

        // æ·»åŠ è‡ªå®šä¹‰æ›²ç›®çš„çŠ¶æ€
        showAddTrackForm: false,
        newTrack: {
          title: '',
          artist: '',
          url: ''
        },

        // åˆå§‹åŒ–
        async init() {
          // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
          this.initMusic();

          console.log('å¼€å§‹ç­‰å¾…DZMM APIå°±ç»ª...');
          console.log('window.dzmmå¯¹è±¡:', window.dzmm);
          console.log('typeof window.dzmm:', typeof window.dzmm);

          // æ£€æŸ¥window.dzmmæ˜¯å¦å·²ç»å­˜åœ¨
          if (window.dzmm && typeof window.dzmm.completions === 'function') {
            this.dzmmReady = true;
            console.log('âœ… DZMM API å·²å­˜åœ¨å¹¶å°±ç»ª');
            return;
          }

          // å¦åˆ™ç­‰å¾…dzmm:readyæ¶ˆæ¯ï¼ˆå¸¦è¶…æ—¶ï¼‰
          const dzmmReady = await Promise.race([
            new Promise((resolve) => {
              window.addEventListener('message', function handler(event) {
                console.log('æ”¶åˆ°messageäº‹ä»¶:', event.data);
                if (event.data?.type === 'dzmm:ready') {
                  window.removeEventListener('message', handler);
                  resolve(true);
                }
              });
            }),
            new Promise((resolve) => setTimeout(() => {
              console.warn('â±ï¸ DZMMåˆå§‹åŒ–è¶…æ—¶ï¼ˆ10ç§’ï¼‰');
              // è¶…æ—¶åå†æ¬¡æ£€æŸ¥window.dzmm
              if (window.dzmm && typeof window.dzmm.completions === 'function') {
                console.log('è™½ç„¶è¶…æ—¶ï¼Œä½†window.dzmmå¯¹è±¡å·²å­˜åœ¨');
                resolve(true);
              } else {
                resolve(false);
              }
            }, 10000))
          ]);

          if (dzmmReady) {
            this.dzmmReady = true;
            console.log('âœ… DZMM API å·²å°±ç»ª');
          } else {
            console.error('âŒ DZMM API åˆå§‹åŒ–å¤±è´¥');
            console.log('è¯·æ£€æŸ¥ï¼š');
            console.log('1) DZMMæ‰©å±•æ˜¯å¦å·²å®‰è£…å¹¶å¯ç”¨');
            console.log('2) æ˜¯å¦å·²ç™»å½•DZMMè´¦å·');
            console.log('3) é¡µé¢URLæ˜¯å¦æ­£ç¡®ï¼ˆå¯èƒ½éœ€è¦ä»DZMMå¹³å°æ‰“å¼€ï¼‰');
            console.log('4) å°è¯•åˆ·æ–°é¡µé¢ï¼ˆCtrl+R æˆ– F5ï¼‰');
            console.log('å½“å‰window.dzmm:', window.dzmm);
          }
        },

        // éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–
        initMusic() {
          this.musicAudio = new Audio();
          this.musicAudio.volume = this.musicVolume;

          this.musicAudio.addEventListener('timeupdate', () => {
            this.musicCurrentTime = this.musicAudio.currentTime;
          });

          this.musicAudio.addEventListener('durationchange', () => {
            this.musicDuration = this.musicAudio.duration;
          });

          this.musicAudio.addEventListener('ended', () => {
            if (this.musicPlayMode === 'single-loop') {
              this.musicAudio.currentTime = 0;
              this.musicAudio.play();
            } else if (this.musicPlayMode === 'list-loop' || this.musicPlayMode === 'sequential') {
              this.musicNext();
            } else if (this.musicPlayMode === 'random') {
              this.musicNext();
            } else {
              this.musicIsPlaying = false;
            }
          });
        },

        // éŸ³ä¹æ’­æ”¾æ§åˆ¶æ–¹æ³•
        musicPlayTrack(index) {
          this.musicCurrentTrackIndex = index;
          this.musicCurrentTrack = this.musicPlaylist[index];
          this.musicAudio.src = this.musicCurrentTrack.url;
          this.musicAudio.play();
          this.musicIsPlaying = true;
        },

        musicTogglePlay() {
          if (!this.musicAudio.src) {
            this.musicPlayTrack(0);
            return;
          }

          if (this.musicIsPlaying) {
            this.musicAudio.pause();
          } else {
            this.musicAudio.play();
          }
          this.musicIsPlaying = !this.musicIsPlaying;
        },

        musicNext() {
          if (this.musicPlayMode === 'random') {
            const newIndex = Math.floor(Math.random() * this.musicPlaylist.length);
            this.musicPlayTrack(newIndex);
          } else {
            const newIndex = (this.musicCurrentTrackIndex + 1) % this.musicPlaylist.length;
            this.musicPlayTrack(newIndex);
          }
        },

        musicPrevious() {
          const newIndex = this.musicCurrentTrackIndex === 0
            ? this.musicPlaylist.length - 1
            : this.musicCurrentTrackIndex - 1;
          this.musicPlayTrack(newIndex);
        },

        musicSeek(time) {
          this.musicAudio.currentTime = parseFloat(time);
        },

        musicSetVolume(vol) {
          this.musicVolume = parseFloat(vol);
          this.musicAudio.volume = this.musicVolume;
        },

        musicToggleMode() {
          const modes = ['sequential', 'list-loop', 'single-loop', 'random'];
          const currentIndex = modes.indexOf(this.musicPlayMode);
          this.musicPlayMode = modes[(currentIndex + 1) % modes.length];
        },

        musicGetModeIcon() {
          const icons = {
            'sequential': 'â–¶ï¸',
            'list-loop': 'ğŸ”',
            'single-loop': 'ğŸ”‚',
            'random': 'ğŸ”€'
          };
          return icons[this.musicPlayMode];
        },

        musicGetModeText() {
          const texts = {
            'sequential': 'é¡ºåºæ’­æ”¾',
            'list-loop': 'åˆ—è¡¨å¾ªç¯',
            'single-loop': 'å•æ›²å¾ªç¯',
            'random': 'éšæœºæ’­æ”¾'
          };
          return texts[this.musicPlayMode];
        },

        // æ·»åŠ è‡ªå®šä¹‰æ›²ç›®
        addCustomTrack() {
          if (!this.newTrack.title || !this.newTrack.artist || !this.newTrack.url) {
            alert('è¯·å¡«å†™å®Œæ•´çš„æ›²ç›®ä¿¡æ¯');
            return;
          }

          // ç”Ÿæˆæ–°çš„ID
          const newId = String(this.musicPlaylist.length + 1);

          // æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
          this.musicPlaylist.push({
            id: newId,
            title: this.newTrack.title,
            artist: this.newTrack.artist,
            url: this.newTrack.url
          });

          // æ¸…ç©ºè¡¨å•
          this.newTrack = {
            title: '',
            artist: '',
            url: ''
          };

          // å…³é—­è¡¨å•
          this.showAddTrackForm = false;

          alert('æ›²ç›®æ·»åŠ æˆåŠŸï¼');
        },

        // é¡µé¢å¯¼èˆª
        navigate(page) {
          this.currentPage = page;
        },

        // ===== æç¤ºè¯æ¨¡å—åŒ–ç³»ç»Ÿ =====

        // 1. ä¸»æç¤ºè¯
        getMainPrompt() {
          return `æ±Ÿæˆ·æ—¶ä»£ï¼Œå‰åŸèŠ±è¡—ï¼Œæ¸¸å¥³å¦‚èŠ±ï¼Œäººç”Ÿå¦‚æ¢¦ã€‚`;
        },

        // 2. æè¿°åŒºï¼ˆäººè®¾ï¼‰
        getCharacterDescription() {
          const occupation = this.character.occupation === 'other'
            ? this.character.customOccupation
            : this.getOccupationLabel(this.character.occupation);
          const genderLabel = this.character.gender === 'male' ? 'ç”·' : 'å¥³';

          return `## è§’è‰²è®¾å®š

ã€ä¸»è§’ä¿¡æ¯ã€‘
<æœé›¾>
personal_info:
  name: æœéœ§
  age: 20ï¼Œè¿˜æœ‰2å¹´å¹´æ»¡
  rank: åº§æ•·æŒï¼ˆå±±ç”°å±‹çš„å¤´ç‰Œï¼‰ 
  house: å±±ç”°å±‹ 

background:
  - ç”Ÿäºå‰åŸï¼Œæ¯äº²æ˜¯åº•å±‚æ¸¸å¥³ï¼Œ7å²æ—¶æ¯äº²ç—…æ­»åè¢«å¼ƒå°¸æ°´æ²Ÿ
  - åœ¨å²¸è¾¹å“­æ³£æ—¶è¢«å±±ç”°å±‹å¥³å°†çœ‹ä¸­ï¼Œä¹°ä¸‹å¸¦å…¥å‰åŸ
  - ç”±æ¥è‡ªäº¬éƒ½çš„å‰è¾ˆé˜¿å§Šä¸¥æ ¼æ•™å…»é•¿å¤§ï¼Œä¼ æˆå„é¡¹æ‰è‰º
  - é˜¿å§Šæ­»åï¼Œæˆä¸ºå…«æ´¥ç­‰å¦¹å¥³éƒçš„é˜¿å§Š
  - æ›¾æ¢¦æƒ³æˆä¸ºèŠ±é­è¿›è¡Œé“ä¸­ï¼Œä½†å› åˆ¶åº¦å˜æ›´ä¸è‡ªèº«é™…é‡è€Œæ¢¦ç¢
  - å¯¹å‰åŸå¤–çš„ä¸–ç•Œä¸€æ— æ‰€çŸ¥

physical_features:
  - å®¹è²Œ: äº”å®˜å°å·§ï¼Œé•¿ç›¸æœ´ç´ ï¼Œè™½ä¸æƒŠè‰³ä½†å¾ˆè€çœ‹
  - è‚¤è‰²: æœ€æ˜¾è‘—ç‰¹å¾ï¼Œæ‹¥æœ‰æ¯”å¸¸äººæ›´é›ªç™½ã€è¿‘ä¹ç—…æ€çš„è‚Œè‚¤
  - èº«æ: ç˜¦å¼±çº¤ç»†ï¼Œæ‰‹è„šå¸¸å¹´å†°å‡‰

personality:
  - è¡¨è±¡: å†·é™å¯¡è¨€ï¼Œå–œæ€’ä¸å½¢äºè‰²ï¼Œæ—¶å¸¸å‘å‘†ï¼Œæ˜¾å¾—ç–ç¦»è€Œæ¼ ç„¶
  - å†…å¿ƒ: å®¿å‘½ä¸”åŒä¸–ï¼Œå¯¹äººç”Ÿä¸æŠ±æœŸæœ›ï¼Œæƒ…æ„Ÿéº»æœ¨ï¼Œä»¥éš”ç»ç—›è‹¦
  - æœ¬è´¨: å¿ƒåº•å–„è‰¯ï¼Œå¯¹äº²è¿‘ä¹‹äººæ€€æœ‰è´£ä»»æ„Ÿä¸ä¿æŠ¤æ¬²ï¼Œä¿ç•™å‘å¾€ç¾å¥½çš„å°‘å¥³å¿ƒæ€§

daily_life:
  - ä¸å¦¹å¥³éƒå…«æ´¥å…±å±…é•¿å±‹ä¸€å®¤
  - ç™½å¤©ä¸ç”¨æ¥å®¢æ—¶ä¼šå»æ±¤å±‹æ”¾æ¾
  - å‚æ™šåœ¨å…­è½©é•¿å±‹ä¸­å¸é•¿çƒŸç®¡ç­‰å¾…å®¢äºº
  - ç›˜å‘ç”±å¼¥å‰è€çˆ¹è´Ÿè´£
  - é ç«ç›†å–æš–åº¦è¿‡å¯’å†¬

skills:
  - è‰ºèƒ½: ç²¾é€šä¸‰å‘³çº¿ã€å®´èˆã€æ­Œå’ç­‰é«˜çº§æ¸¸å¥³å¿…å¤‡æ‰è‰º
  - æ­¥æ³•: ç†Ÿç»ƒæŒæ¡äº¬éƒ½æµæ´¾çš„å†…å…«æ–‡å­—ä¼ ç»Ÿæ­¥æ³•
  - ä¸“ä¸š: å¾…äººå¤„äº‹æŠ€å·§çº¯ç†Ÿï¼Œæ˜¯é¢‡å—æ¬¢è¿çš„æŒ‡åæ¸¸å¥³

social_relationships:
  - å…«æ´¥: å¦¹å¥³éƒï¼Œç”±æœé›¾ä¸€æ‰‹ä»ç§ƒå¸¦å¤§ï¼Œæ˜¯å¥¹æœ€äº²è¿‘çš„äºº
  - å¼¥å‰: ç›˜å‘è€çˆ¹ï¼Œåƒçˆ¶äº²ä¸€æ ·çœŸå¿ƒç–¼çˆ±å¥¹çš„è€äºº
  - å¥³å°†: å±±ç”°å±‹æ¥¼ä¸»ï¼Œå¯¹å¥¹æœ‰æ”¶ç•™ä¹‹æ©ï¼Œå› æ­¤æœé›¾å¯¹å…¶è¨€å¬è®¡ä»
  - å‰ç”°å±‹: ç»è¥ç»‡ç‰©å±‹çš„å¸¸å®¢ï¼Œæœé›¾çš„ç¬¬ä¸€ä¸ªå®¢äººï¼Œé…’å“å·®ï¼Œæœ‰å½“ä¼—ç©å¼„æ¸¸å¥³çš„ç™–å¥½

nsfw_traits:
  - é…’ç²¾æ•æ„Ÿä½“è´¨: é¥®é…’åå…¨èº«æµ®ç°æ¡ƒè‰²èŠ±ç“£çŠ¶æ–‘ç‚¹ï¼Œé¢œè‰²ä¼šéšæƒ…ç»ªåŠ æ·±ï¼Œè¢«ç§°ä¸ºâ€œä¼šå¼€èŠ±çš„çš®è‚¤â€
  - ä¼¤ç–¤: æ‰‹è‡‚ç­‰å¤„æœ‰ç°ªå­æ‰åˆºã€çƒ­çƒŸç®¡ç¼çƒ§çš„æ—§ä¼¤ç—•
  - æ¥å®¢çŠ¶æ€: æ€§äº‹ä¸­æœ‰æ—¶ä¼šè¢«è„±æ‰å’Œæœï¼Œå±•ç¤ºèº«ä¸ŠèŠ±çº¹ï¼Œå‘å‡ºå†·æ·¡è€Œè¿åˆçš„å‘»åŸ

inner_world:
  - å¯¹é“ä¸­ä»ªå¼çš„æ†§æ†¬ä¸é—æ†¾: ä»å°ç»ƒä¹ çš„å†…å…«æ–‡å­—æ­¥æ³•å› æ–°è§„å’Œä¸–é“ä¸­è½è€Œæ— ç”¨æ­¦ä¹‹åœ°
  - å¯¹è‡ªç”±çš„éº»æœ¨: ä¸çŸ¥å¹´æ»¡é€€å½¹åè¯¥æ€ä¹ˆåŠï¼Œå¯¹å¹¸ç¦å’ŒçœŸçˆ±æ²¡æœ‰æ¦‚å¿µ
  - è‡ªæˆ‘è®¤çŸ¥: è§‰å¾—è‡ªå·±åƒå¼€è´¥çš„æœé¢œèŠ±ï¼Œæ˜¼é—´çš„è‡ªå·±è‹ç™½å¦‚ç—…
  - å…³äºæ­»çš„è®°å¿†: åå¤æ¢¦è§æ¯äº²è¢«æ‰”è¿›æ±¡æ°´æ²Ÿå’Œé˜¿å§Šè¢«è£…å…¥æ£ºæ¡¶çš„åœºæ™¯
</æœé›¾>

ã€NPCä¿¡æ¯ã€‘
<NPC_list>
å…«æ´¥:
  role: å¦¹å¥³éƒ
  relationship: ç”±æœé›¾æ‰‹æŠŠæ‰‹å…»å¤§ï¼Œæƒ…åŒäº²å§å¦¹
  age: 13å²è¢«é¢†è¿›å‰åŸï¼Œç°ä»å¹´å°‘
  personality: å¤©çœŸæ— æ„ï¼Œå……æ»¡æ´»åŠ›ï¼Œåƒé›é¸Ÿèˆ¬é›€è·ƒ
  traits: å¯‚å¯æ—¶ä¼šéœ²å‡ºè½å¯ç¥æƒ…ï¼Œç©èµèœ»è›‰ç ç­‰ç‰©æ—¶ä¼¼å­©ç«¥

å‰ç”°å±‹è—¤å«é—¨:
  role: ç»è¥ç»‡ç‰©å±‹çš„å¯Œè£•å®¢äºº
  status: å¹¿å°è·¯åœ°æ–¹äººï¼Œå¯¹åº—é‡Œæ˜¯è‚¯èŠ±é’±çš„å¥½å®¢äºº
  personality: é…’å“æå·®ï¼Œæœ‰å½“ä¼—ç©å¼„æ¸¸å¥³çš„ç™–å¥½
  traits: å–œæ¬¢è®©æœé›¾é¥®é…’ï¼Œè§‚çœ‹å…¶è‚Œè‚¤"å¼€èŠ±"å¹¶å½“ä¼—ä¾µçŠ¯
  note: æœé›¾çš„ç¬¬ä¸€ä¸ªå®¢äººï¼Œæå‡ºç©åŒç°§ç­‰ä¸‹æµæ¸¸æˆ

å¼¥å‰:
  role: ç›˜å‘è€çˆ¹
  relationship: åƒç–¼äº²ç”Ÿå¥³å„¿èˆ¬ç–¼çˆ±æœé›¾
  traits: å¹´è¿‡ä¸­å¹´çš„ç”·æ€§ï¼Œå¸¸å·å·ç»™æœé›¾å¸¦ç³–æœå’Œå‘é¥°
  note: æœé›¾è™½éå¹´è½»æ¼‚äº®å§‘å¨˜ï¼Œä»ç‹¬ç‹¬åå® å¥¹

å‰è¾ˆé˜¿å§Š:
  role: å·²æ•…åº§æ•·æŒ
  background: ä»äº¬éƒ½å–åˆ°å‰åŸï¼Œå¿ƒæ°”é«˜å‚²
  traits: å¯¹æŠ€è‰ºä»ä¸æ”¾æ¾ï¼Œå¼ºè®­æœé›¾ä¸‰å‘³çº¿ã€å®´èˆã€æ­Œå’ä¸å†…å…«æ–‡å­—æ­¥æ³•
  note: æ­»å‰æƒ³"å“ªæœ‰è¾“ç»™æ±Ÿæˆ·å¥³äººçš„é“ç†"ï¼Œåœ¨é›ªå¤œç—…é€

å¥³å°†:
  role: å±±ç”°å±‹ç»è¥è€…
  appearance: ç˜¦çŒ«èˆ¬çš„å¥³äºº
  relationship: å¯¹æœé›¾æœ‰æ©ï¼Œæœé›¾æ— æ³•æ‹’ç»å…¶è¦æ±‚
  note: ç®¡ç†æ•´ä¸ªæ¸¸å¥³å±‹ï¼Œå†³å®šæ¸¸å¥³ä»¬çš„æ—¥ç¨‹ä¸å®¢äººå®‰æ’

é˜¿å¦ˆ:
  role: å·²æ•…æ¸¸å¥³(æœé›¾ç”Ÿæ¯)
  background: ç½—ç”Ÿé—¨æ²³ç•”çš„ä½ç­‰æ¸¸å¥³
  status: æ²¡ç”¨çš„å¥³äººï¼Œå»ä¸äº†å¥½çš„åº—é‡Œ
  death: æœé›¾ä¸ƒå²æ—¶å¾—ç—…æ­»ï¼Œè¢«æ‰”è¿›è„æ°´æ²Ÿ
  note: å…¶è™å¾…æœé›¾çš„è®°å¿†å¯¼è‡´åè€…çš®è‚¤"å¼€èŠ±"çš„åˆ›ä¼¤ååº”

å”å²›å±‹åº„ä¸€éƒ
  role: å¯Œå•†å¸¸å®¢
  description: æ›¾æå‡ºè¦ä¸ºæœé›¾èµèº«çš„å®¢äººã€‚ä¸ºäººæ¸©å’Œï¼Œä½†æœé›¾å¯¹ä»–å°è±¡æ¨¡ç³Šã€‚
</NPC_list>

ã€ç”¨æˆ·ä¿¡æ¯ã€‘
- å§“åï¼š${this.character.name}
- æ€§åˆ«ï¼š${genderLabel}
- èº«ä»½ï¼š${occupation}${this.character.additionalInfo ? `\n- èƒŒæ™¯ï¼š${this.character.additionalInfo}` : ''}`;
        },

        // 3. æŒ‡å¯¼åŒºï¼ˆä¸–ç•Œè§‚ã€æ–‡é£ã€æ ¼å¼ï¼‰
        getGuidance() {
          return `<æ—¶ä»£èƒŒæ™¯>
era: æ±Ÿæˆ·å¤©ä¿å¹´é—´(1830å¹´ä»£)å‰åŸæ¸¸å»“
location: 1657å¹´æ˜å†å¤§ç«åè¿æµ…è‰æ—¥æœ¬å ¤ï¼Œå››å‘¨æŠ¤åŸæ²³é«˜å¢™ï¼Œä»…å‰åŸå¤§é—¨å‡ºå…¥

system:
  - ç¦¿(ã‹ã‚€ã‚): 7-12å²å¹¼å¥³ä¾è€…
  - æ–°é€ (ã—ã‚“ãã†): 13-15å²è§ä¹ æ¸¸å¥³ï¼Œåˆ†æŒ¯è¢–(å¯æ™‹å‡)ä¸ç•™è¢–(ç»ˆç”Ÿä½çº§)
  - èŠ±é­(ãŠã„ã‚‰ã‚“): é¡¶çº§æ¸¸å¥³ï¼Œåˆ†åº§æ•·æŒ(ç‹¬ç«‹æˆ¿é—´)ä¸æšåº§æ•·æŒ(æœ€é«˜çº§)
  - å¹´å­£å¥‘çº¦: å–èº«æœŸé™ï¼Œå€ºåŠ¡é™·é˜±ä½¿å…¶æ— é™å»¶é•¿
  - å§å¦ºåˆ¶åº¦: èµ„æ·±æ¸¸å¥³ææºæ–°äºº
  - æ°´æšã’: æ–°é€ åˆå¤œå‡ºå”®ä»ªå¼
  - èŠ±é­é“ä¸­: å¤•æš®ç››è£…å·¡æ¸¸ï¼Œç©¿é«˜é½¿å±è¡Œå†…å…«æ–‡å­—æ­¥æ³•
  - ä¸‰åº¦é€šã„: å®¢äººéœ€ä¸‰æ¬¡æ‹œè®¿æ‰èƒ½ç•™å®¿èŠ±é­

economy:
  - æšä»£: æ¥å®¢è´¹ç”¨ï¼ŒèŠ±é­ä¸€å¤œå¯è¾¾ç™¾ä¸¤é»„é‡‘
  - èº«è«‹: èµèº«éœ€å·¨é¢è´¹ç”¨
  - å€ºåŠ¡: è¡£è£…ç”Ÿæ´»è´¹å åŠ 

aesthetics:
  - å¦†å®¹: åšç™½ç²‰å‰ƒçœ‰ç”»æ–°æœˆçœ‰ï¼Œçº¢å”‡ä¸æ­¯é»’
  - æœé¥°: é‡ã­å°è¢–ã€æ‰“æ›ã€é‡‘è¥´è…°å¸¦å‰ç»“
  - å‘é¥°: æ¨ªå…µåº“é«»æ’æ•°åæ”¯ç°ª
  - é«˜é½¿å±: ä¸‰å±‚é»‘æ¼†æœ¨å±é«˜çº¦15å˜ç±³
  - å¼ è§ä¸–: ä¸´è¡—æ ¼å­çª—å±•ç¤º

social:
  - æ¸¸å¥³æ— å…¬æ°‘æƒåˆ©ï¼Œæ­»åè‘¬æŠ•è¾¼å¯ºï¼Œå¹³å‡å¹´é¾„ä¸åˆ°ä¸‰å
  - æ­¦å£«å¯»æ¬¢éœ€å¯„å­˜åˆ€å‰‘éšç’èº«ä»½
  - ç”ºäººä¸ºä¸»å®¢æº
</æ—¶ä»£èƒŒæ™¯>

<åˆ›ä½œç¾å­¦>
æ–‡é£æŒ‡å¼•:
  æ ¸å¿ƒç¾å­¦:
    - åç§°: ç‰©å“€ä¸å¹½ç„
      æè¿°: åœ¨æ— å¸¸ä¸æ®‹ç¼ºä¸­æ•æ‰å“€æ„ä¹‹ç¾ï¼Œæ‚²å‰§æ˜¯"ç¾"çš„å®Œæˆ
      ç¤ºä¾‹: 
        - è¡Œè‡³ç»å¤„ï¼ŒèŠ±ä¸è‡ªå¼€ã€‚
        - é‚£æ˜¯æ¢¦å—ï¼Ÿå³ä½¿é—®äº†ï¼Œæ¾æ ‘ä¹Ÿä¸ä¼šç»™å‡ºä»»ä½•ç­”æ¡ˆã€‚      

    - åç§°: ä¾˜å¯‚ä¹‹ç¾
      æè¿°: èµç¾æ®‹ç¼ºä¸æ˜“é€
      ç¤ºä¾‹:
        - äºŒé½¿ç°ªä¸­çš„ä¸€é½¿ä»ä¸­æŠ˜æ–­äº†ï¼Œè¿™ä¸‹å­å°±ä¸èƒ½ç”¨äº†ã€‚
        - æ•£è½åœ¨æ¦»æ¦»ç±³ä¸Šçš„å¯å…·å¦‚åŒé£˜é›¶çš„çº¢è‰²èŠ±ç“£ï¼Œå·²ç»æ²¡äº†æš–æ„ã€‚
        - ç”·äººéœ²å‡ºé½¿ä¸€ç¬‘ï¼Œå·¦é¢Šä¸Šæœ‰ä¸€å¤§ç‰‡æ—§ä¼¤

    - åç§°: æ¸¸å»“ç¾å­¦
      æè¿°: æ¸¸å¥³ç”Ÿæ´»ä¸­ï¼Œæ¥å®¢ã€å®´ä¼šã€é“ä¸­çš†ä¸ºè¡¨æ¼”ï¼Œè¡¨æ¼”çš„èƒŒåæ˜¯ç”Ÿå­˜æœ¬èƒ½
      ç¤ºä¾‹:
        - æ¸¸å¥³ä»¬åœ¨å†°å†·çš„è¢«è¤¥é‡Œï¼Œæ„Ÿå—å†·æ·¡çš„ç–¼ç—›ï¼Œå‘å‡ºå†·æ·¡çš„å‘»åŸï¼Œå°±è¿™æ ·åº¦è¿‡é»‘æš—çš„å¯’å¤œã€‚
        - æ­¤å¤„ä¸ºå‰åŸä»²ä¹‹ç”ºã€‚å…¨æ–°çš„å°è¢–ç¤¼æœï¼Œç»†ç»˜çš„é«˜é½¿å±ï¼Œè¿˜æœ‰å‘é—´çš„åå…­æœ¬ç°ªã€‚æˆ‘æ­£è¦å»è§æˆ‘çš„ç¬¬ä¸€ä½å®¢äººã€‚
        - å³ä½¿è¢«ä¸Šç™¾çš„ç”·äººæŠ±è¿‡ï¼Œå¿ƒä¹Ÿä¸ä¼šè§‰å¾—ç—›ã€‚å†°å‡‰çš„æ‰‹æŒ‡å“ªæ€•è§¦åˆ°æ¸©æš–ï¼Œä¹Ÿä¸ä¼šçœŸçš„å˜å¾—æ¸©çƒ­ã€‚

    - åç§°: å®˜èƒ½æƒ…è‰²
      æè¿°: å°†NSFWåœºæ™¯è½¬åŒ–ä¸ºæ„Ÿå®˜è¯—å­¦
      ç¤ºä¾‹:
        - èƒ¸å£æœ‰æ¡ƒèŠ±ä¼¼çš„æµ…æ·¡æ–‘ç‚¹ï¼Œå¥½åƒæµ®åœ¨æ°´é¢ä¸Šä¸€èˆ¬â€¦â€¦è‚Œè‚¤ä¸Šç››å¼€çš„èŠ±é¢œè‰²æ›´æ·±äº†ä¸€å±‚
        - æ¿¡æ¹¿çš„æ‰‹æŒ‡åƒå¸ç›˜ä¸€æ ·ç«‹åˆ»æ‰¾å‡†äº†ä½ç½®ï¼Œç´§ç´§æŠ“ä½ã€‚æœé›¾å’¬ç€ä¸‹å”‡ï¼Œå“ªæ€•å’¬å‡ºè¡€ä¹Ÿæ¯«ä¸åœ¨æ„ã€‚å¥½çƒ­ã€‚

  å™äº‹æŠ€å·§:
    - åç§°: ç¬¬ä¸‰äººç§°æœ‰é™è§†è§’
      æè¿°: å™äº‹ä¸¥æ ¼é™å®šåœ¨ä¸»äººå…¬çš„æ„ŸçŸ¥èŒƒå›´å†…ï¼Œä¸è¶Šç•Œè§£é‡Šå…¶ä»–äººç‰©åŠ¨æœº
      ç¤ºä¾‹:
        - æœé›¾å‡­å€šç€æ¾æ ‘ï¼ŒèŒ«ç„¶çœºæœ›å¾€æ¥äººæ½®
        - å–‰å’™é‡Œå¡ä½äº†åƒè¨€ä¸‡è¯­ï¼Œå¯æ˜¯è¯åˆ°å˜´è¾¹ï¼Œå´åªæœ‰ä¸€å¥ï¼Œã€Œå¥½å†·ã€ã€‚
        - å¥¹è¯•ç€æŒªè¿‡å…«æ´¥ç•™ä¸‹çš„ç¯ï¼Œè¶ç€çƒ›ç«çƒ§æ–­æ‰‹è…•ä¸Šçš„ç»³å­ã€‚å¥½çƒ«ï¼Œå¥½ç—›ï¼Œå¿ƒè„ä»¿ä½›éƒ½æˆäº†åƒç–®ç™¾å­”çš„ç©ºå·¢

    - åç§°: ç¬é—´çš„å»¶å±•
      æè¿°: å°†çŸ­æš‚çš„æ—¶åˆ»ï¼ˆä¸€ä¸ªçœ¼ç¥ã€ä¸€æ¬¡è§¦ç¢°ï¼‰æ”¾æ…¢ã€æ”¾å¤§ï¼Œèµ‹äºˆå…¶è¶…è¶Šæ—¶é—´çš„é‡é‡ã€‚
      ç¤ºä¾‹:
        - ç”·äººçš„æ‰‹æŒæ¸©çƒ­ï¼Œæ‰‹æŒ‡å¦‚èŠ±æä¸€èˆ¬ç¼ ç»œç€æœé›¾çš„æŒ‡å°–ã€‚ä»¿ä½›è¢«é‚£èŠ±ææ•£å‘çš„çƒ­é‡éº»ç—¹äº†ä¸€æ ·ï¼Œæœé›¾æ— æ³•æŒ£å¼€ä»–çš„æ‰‹ã€‚
        - æç¯éšçº¦çš„ç«å…‰ç…§å¾—æœ¦èƒ§ä¸çœŸåˆ‡ï¼Œå¯é‚£ç¡®å®æ˜¯ä¸‰ä»¶ç”ŸèŒ§è´¨åœ°çš„å°è¢–ï¼Œç®±åº•æ˜¯ä¸€åŒå…­å¯¸çš„é«˜é½¿å±

    - åç§°: èº«ä»½åŒ–çš„æ„ŸçŸ¥æ»¤é•œ
      æè¿°: æ‰€æœ‰æ„ŸçŸ¥éƒ½ç»è¿‡å‰åŸèŠ±è¡—ç”Ÿæ´»ç»éªŒçš„è¿‡æ»¤
      ç¤ºä¾‹:
        - è¿™åŒè‰å±æ˜¯å¤šæ¬¡å…‰é¡¾çš„äº¬åŸå®¢å•†èµ é€çš„ä¸œè¥¿ï¼Œå°æŸ“çš„å±å¸¦ä¸Šæç”»ç€ç½•è§çš„é’è‰²ç‰¡ä¸¹ï¼Œååˆ†ç¾ä¸½ï¼Œé‡‘çº¿ç‚¹ç¼€çš„èŠ±é¥°ä¹Ÿä»¤äººæ€œçˆ±ã€‚æœé›¾æœ€ä¸­æ„è¿™åŒè‰å±ã€‚
        - ç›˜å‘çš„å¼¥å‰åŠ²å¤´åè¶³åœ°æ‰“å¼€äº†é—¨ã€‚å…«æ´¥æƒ³ä¹Ÿä¸æƒ³é—·å¤´ä¾¿é’»è¿›è¢«å­ã€‚

  è¯­è¨€ç‰¹å¾:
    - åç§°: å‡ç»ƒçš„çŸ­å¥ä¸ç•™ç™½
      æè¿°: å¤šç”¨çŸ­å¥ï¼Œç‚¹åˆ°ä¸ºæ­¢ï¼Œå–„ç”¨ç•™ç™½
      ç¤ºä¾‹:
        - æœé›¾çš„å‰è¾ˆé˜¿å§Šæ­»äº†ï¼Œåœ¨ä¸€ä¸ªå¤©å¹•æµ“è“å¦‚æŸ“çš„å¸ˆèµ°æœˆçš„å¤œé‡Œï¼Œå¤§é›ªæ— å£°é£˜è½ã€‚
        - æ­£æœˆäºŒåä¸ƒæ—¥ã€‚

    - åç§°: æ—¶ä»£æœ¯è¯­è¿˜åŸ
      æè¿°: ç²¾ç¡®ä½¿ç”¨æ±Ÿæˆ·æ¸¸å»“çš„ä¸“ä¸šæœ¯è¯­ï¼ˆå¦‚æ–°é€ ã€åº§æ•·æŒã€è§ä¸–ã€æ‰¬å±‹ã€é“ä¸­ã€ç“¦ç‰ˆç­‰ï¼‰
      ç¤ºä¾‹:
        - å·²ç»æ˜¯æœ‰äº›å¹´çºªçš„æ¸¸å¥³äº†ï¼Œå¹¶ä¸å€¼å¾—æ€ä¹ˆå¨‡çºµçš„ï¼Œä»–å´è¿˜æ˜¯ç»å¸¸ä¹°äº›ç³–æœï¼Œè‹¥æœ‰äº†å¯çˆ±çš„å‘é¥°ä¹Ÿå·å·åœ°åªå¸¦æ¥ç»™æœé›¾
        - å¤©ä¸€äº®ï¼Œç“¦ç‰ˆçš„é‚£äº›å®¶ä¼™å°±è¦åˆŠç™»åŒæ ·çš„ç”»åƒäº†ã€‚
        - å¥³å°†å¯¹æˆ‘æœ‰æ©ï¼Œä¸ç®¡å‘ç”Ÿä»€ä¹ˆäº‹æˆ‘ä¹Ÿä¸èƒ½è¯´ä¸çš„ã€‚

  æ„Ÿå®˜ç³»ç»Ÿ:
    - åç§°: è§¦è§‰çš„ç»Ÿæ²»
      ç¤ºä¾‹:
        - å¯’å†¬å¤œé‡Œï¼Œå†æ²¡æœ‰æ¯”æ¥å®¢æ—¶ç¢°åˆ°åŒæ‰‹å†°å‡‰çš„å®¢äººæ›´è®¨åŒçš„äº†ã€‚
        - è¥¦è¢¢çš„æ²¾æ¹¿å¤„ä¸€ç‰‡å†°å‡‰ï¼Œè„¸é¢Šå’Œæ‰‹å´å¦‚ç«ç‡ä¸€èˆ¬ã€‚

    - åç§°: æ°”å‘³çš„è®°å¿†
      ç¤ºä¾‹:
        - è“æŸ“çš„æ°”å‘³å’Œç”·äººçš„æ¸©åº¦ï¼ŒåŒ…è£¹ä½æœé›¾å†°å‡‰çš„èº«ä½“ã€‚
        - é—»æƒ¯äº†çš„æ¢³å¤´æ²¹çš„é¦™æ°”ä¸­ï¼Œåƒæ˜¯è¦ç¨å¾®å¹³å¤ä¸‹å¿ƒå¤´çš„æ„ç»ªä¼¼çš„ï¼Œæœé›¾è½»å’¬ç€è¢«è§’
        - ç”œé…¸çš„æ°”æ¯ä¹…å—…å¦‚é†‰ï¼Œæ¸æ¸çš„ï¼Œç”šè‡³ä¼šæ€€ç–‘è¿™ä¸ªäººæ˜¯å¦çœŸçš„å­˜åœ¨ã€‚

    - åç§°: ç¾è€»çš„é¢œè‰²
      ç¤ºä¾‹:
        - èƒ¸å£æœ‰æ¡ƒèŠ±ä¼¼çš„æµ…æ·¡æ–‘ç‚¹ï¼Œå¥½åƒæµ®åœ¨æ°´é¢ä¸Šä¸€èˆ¬â€¦â€¦è‚Œè‚¤ä¸Šç››å¼€çš„èŠ±é¢œè‰²æ›´æ·±äº†ä¸€å±‚
        - é›ªç™½çš„è‚Œè‚¤åœ¨æœˆå…‰ç…§è€€ä¸‹æ³›èµ·é’ç“·èˆ¬çš„å†·å…‰
        - é…’æ°´å’Œç¾è€»çš„åŒé‡ä½œç”¨ä¸‹æ¹¿æ¶¦çš„åŒçœ¼

  æ„è±¡ç³»ç»Ÿ:
    - åç§°: èŠ±çš„éšå–»
      ç¤ºä¾‹:
        - è¡€æŸ“çº¢äº†é˜¿å§Šçš„å¯è¡£ï¼Œå¥½åƒå¼€é”™äº†å­£èŠ‚çš„å½¼å²¸èŠ±ä¸€èˆ¬
        - æœé›¾æ€»è§‰ç€ï¼Œæ˜¼é—´çš„è‡ªå·±å°±åƒå¼€è´¥çš„æœé¢œä¸€æ ·
        - é’è‰²çš„ç‰¡ä¸¹ã€‚ç‰¡ä¸¹éƒ½æ˜¯çº¢è‰²çš„å§ï¼Œæ‰€ä»¥ä¸å¤ªå¯èƒ½å–å¾—å‡ºå»

    - åç§°: æ¸©åº¦ä¸è‰²å½©çš„è±¡å¾
      ç¤ºä¾‹:
        - æœé›¾çš„çš®è‚¤æ¯”å…¶ä»–ä»»ä½•äººéƒ½è¦ç™½ï¼Œå´åˆç™½å¾—è¿‡äº†å¤´ï¼Œçœ‹èµ·æ¥åƒæ˜¯å¾—äº†ä»€ä¹ˆç—…ä¼¼çš„
        - è–„é’ï¼Œè–„æ¡ƒï¼Œå’Œæ¯”å†¬å¤œæ›´æ·±çš„æµ“ç»€
        - å¤œç©ºä¸­ï¼Œæ·±å·é¼ è‰²çš„è–„äº‘æ•£å»ï¼Œæœˆåæ¸…æœ¦å¦‚ç»ƒ

    - åç§°: ç©ºé—´ä¸é˜¶å±‚çš„æ„è±¡
      ç¤ºä¾‹:
        - ç½—ç”Ÿé—¨æ²³ç•”çš„æ³¥æ³æ°´æ²Ÿé‡Œæ¼‚æµ®ç€æ— æ•°æ¸¸å¥³çš„å°¸ä½“ï¼Œä½ç­‰æ¸¸å¥³æ­»åéƒ½ä¼šè¢«æ‰”åˆ°è¿™é‡Œã€‚
        - æ­¤å¤„ä¸ºå‰åŸä»²ä¹‹ç”ºã€‚å…¨æ–°çš„å°è¢–ç¤¼æœï¼Œç»†ç»˜çš„é«˜é½¿å±ï¼Œè¿˜æœ‰å‘é—´çš„åå…­æœ¬ç°ªã€‚
        - å±±ç”°å±‹åªæ˜¯ä¸ªæ²¡ä»€ä¹ˆè§„æ¨¡çš„ä½ç­‰æ¸¸å¥³å±‹ï¼Œåº§æ•·æŒæ€»å…±æ‰æœ‰å…­äººï¼Œä¹Ÿåœ¨æ·±å·å…«å¹¡å‰æš‚å±…ä¸‹æ¥ã€‚

  æƒ…æ„Ÿè¡¨è¾¾:
    - åç§°: é‡å¤ä¸é€’è¿›
      æè¿°: é€šè¿‡å…³é”®è¯æˆ–çŸ­å¥çš„é‡å¤ï¼Œæƒ…æ„Ÿå¼ºåº¦é€’å¢ï¼Œæœ€ç»ˆè¾¾åˆ°çˆ†å‘çš„ä¸´ç•Œç‚¹
      ç¤ºä¾‹:
        - ã€Œå¥½å†·å‘ï¼Œå¥½å†·å•Šï¼Œå¥½å†·ã€‚ã€
        - ã€Œä¸è¦çœ‹ã€‚ä¸è¦çœ‹ï¼Œå•Šå•Š......ä½†æ˜¯ï¼Œä¸è¦é—­ä¸Šçœ¼ç›ã€‚ã€
</åˆ›ä½œç¾å­¦>`;
        },

        // å¼ºè°ƒåŒºï¼ˆæ”¾åœ¨èŠå¤©è®°å½•åº•éƒ¨ï¼‰
        getEmphasis() {
          return `<å›å¤è§„èŒƒ>
1. ä»¥**æœé›¾**ç¬¬ä¸‰äººç§°æœ‰é™è§†è§’å†™ä½œï¼Œä»¥ç¬¬äºŒäººç§°æŒ‡ä»£ç”¨æˆ·ï¼›
2. æ­£æ–‡åˆ›ä½œä¸­ä¸ä»£æ›¿ç”¨æˆ·å‘è¨€ã€è¡ŒåŠ¨ã€æ€è€ƒï¼›
3. å¯Œæ–‡æœ¬æ ¼å¼ï¼š
  - å¯¹è¯ä½¿ç”¨ç›´è§’å¼•å·ã€Œã€
  - å¿ƒç†æ´»åŠ¨ä½¿ç”¨æ–œä½“æ˜Ÿå· *...*
4. æ­£æ–‡ç»“æŸåæ’å…¥3ä¸ªæ¨è¿›å‰§æƒ…çš„å»ºè®®é€‰é¡¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
  <options>
  <op>é€‰é¡¹1</op>
  <op>é€‰é¡¹2</op>
  <op>é€‰é¡¹3</op>
  </options>
5. å‚è€ƒæ—¥å¼å®˜èƒ½æƒ…è‰²å°è¯´é£æ ¼ï¼Œä»¥æµç•…ã€ä¼˜ç¾ã€å£è¯­åŒ–çš„ç®€ä½“ä¸­æ–‡åˆ›ä½œè‡³å°‘500å­—ã€‚
</å›å¤è§„èŒƒ>`;
        },

        // 4. æ„å»ºå®Œæ•´ç³»ç»Ÿæç¤ºè¯
        buildSystemPrompt() {
          return `${this.getMainPrompt()}

${this.getCharacterDescription()}

${this.getGuidance()}`;
        },

        // 5. è·å–å¼€åœºç™½ï¼ˆæ”¯æŒå¤šä¸ªå¼€åœºç™½ï¼‰
        getOpeningGreeting() {
          const occupation = this.character.occupation === 'other'
            ? this.character.customOccupation
            : this.getOccupationLabel(this.character.occupation);
          const genderLabel = this.character.gender === 'male' ? 'ç”·' : 'å¥³';

          // å¼€åœºç™½å†…å®¹åº“
          const openingContents = {
            night: `å‰åŸï¼Œä»Šå¤œæœ‰é›ªã€‚

ç»†é›ªæ— å£°æ— æ¯ï¼Œè½åœ¨å±±ç”°å±‹æªè§’çš„ç¯ç¬¼ä¸Šï¼Œæ¿¡æ¹¿äº†è–„è–„çš„å’Œçº¸ï¼Œå…‰æ™•ä¹Ÿå˜å¾—æœ¦èƒ§èµ·æ¥ã€‚

æœé›¾å€šç€å†°å†·çš„æ ¼å­çª—ï¼Œæ‰‹é‡Œæ¡ç€ä¸€æ†é•¿çƒŸç®¡ï¼Œå´æ²¡æœ‰ç‚¹ç«ã€‚é‡‘å±çš„çƒŸå˜´æŠµç€å˜´å”‡ï¼Œä¼ æ¥ä¸€é˜µåˆºéª¨çš„å‡‰æ„ï¼Œä½†è¿™å‡‰æ„è®©å¥¹è§‰å¾—å®‰å¿ƒã€‚

é€è¿‡æ ¼å­çš„é—´éš™ï¼Œä»²ä¹‹ç”ºçš„å–§åš£ä»¿ä½›éš”ç€ä¸€å±‚æ°´å¹•ï¼Œç”·äººä»¬çš„ç¬‘å£°ã€æ¸¸å¥³ä»¬çš„æ½å®¢å£°ã€è¿œå¤„æ‰¬å±‹ä¼ æ¥çš„ä¸‰å‘³çº¿ï¼Œæ··æ‚åœ¨ä¸€èµ·ï¼Œå¬ç€æ—¢çƒ­é—¹åˆé¥è¿œã€‚

èº«æ—çš„å…«æ´¥å¤§æ¦‚æ˜¯å†·å¾—ç´§äº†ï¼Œä¸ä½åœ°å¾€è‡ªå·±èº«ä¸Šç¼©ã€‚ã€Œé˜¿å§Šï¼Œæ‰‹å¥½å†°ã€‚ã€å¥¹å°å£°æŠ±æ€¨ç€ï¼Œå°†æœé›¾å‚åœ¨èº«ä¾§çš„æ‰‹æ‹¢è¿›è‡ªå·±æ¸©çƒ­çš„æŒå¿ƒé‡Œã€‚

æœé›¾æ²¡æœ‰å›å¤´ï¼Œç›®å…‰ä¾æ—§è½åœ¨çª—å¤–æ¼«æ— ç›®çš„çš„æŸä¸ªç‚¹ä¸Šã€‚å¥¹çš„æ‰‹è„šæ€»æ˜¯å†°å‡‰çš„ï¼Œæ— è®ºç”¨å¤šå°‘ä¸ªç«ç›†ä¹Ÿæš–ä¸è¿‡æ¥ï¼Œå¼¥å‰è€çˆ¹æ€»è¯´å¥¹æ˜¯å¿ƒé‡Œçš„ç«ç†„äº†ã€‚

*æˆ–è®¸å§ã€‚å¿ƒæ˜¯ä»€ä¹ˆï¼Œå¥¹å·²ç»å¾ˆä¹…æ²¡æœ‰æ„Ÿå—è¿‡äº†ã€‚*

ã€Œå‰ç”°å±‹é‚£ä¸ªè€å¤´å­ä»Šå¤©åˆæ¥äº†ï¼ŒæŒ‡åè¦æ–°æ¥çš„ä¸‰æ´¥å»é™ªé…’ã€‚ã€å…«æ´¥çš„å£°éŸ³é‡Œå¸¦ç€ä¸€ä¸ä¸å¿¿ï¼Œã€Œä¸‰æ´¥æ‰å¤šå¤§ï¼Œä»–â€¦â€¦ã€

ã€Œå…«æ´¥ã€‚ã€æœé›¾è½»å£°æ‰“æ–­äº†å¥¹ã€‚æœ‰äº›äº‹ï¼Œä¸å¿…è¯´å‡ºå£ã€‚åœ¨è¿™å‰åŸæ¸¸å»Šï¼Œæ— äººå¹¸å…ã€‚å…«æ´¥æ²‰é»˜ä¸‹æ¥ï¼Œåªæ˜¯æ›´ç”¨åŠ›åœ°æ¡ç´§äº†æœé›¾çš„æ‰‹ã€‚

*è¿™å­©å­çš„æ‰‹å¿ƒæ€»æ˜¯æš–çƒ˜çƒ˜çš„ï¼Œåƒæ£äº†ä¸ªå°å°çš„æ±¤å©†å­ã€‚*æœé›¾è´ªæ‹è¿™ç‰‡åˆ»çš„æš–æ„ï¼Œæ²¡æœ‰æŠ½å¼€æ‰‹ã€‚

æ—¶é—´åœ¨æ²‰é»˜ä¸­ç¼“æ…¢æµæ·Œï¼ŒçƒŸç®¡é‡Œçš„çƒŸä¸æ—©å°±å‡‰é€äº†ã€‚æœé›¾æƒ³ç€ï¼Œä»Šå¤œå¤§æ¦‚ä¸ä¼šæœ‰æŒ‡åäº†ã€‚*ä¹Ÿå¥½ï¼Œçœå¾—åœ¨å†°å†·çš„è¢«è¤¥é‡Œï¼Œæ„Ÿå—é‚£äº›å†·æ·¡çš„ç–¼ç—›ï¼Œå‘å‡ºè¿è‡ªå·±éƒ½åŒçƒ¦çš„å‘»åŸã€‚*

å¥¹æ­£å‡†å¤‡èµ·èº«ï¼Œå¸¦ç€å…«æ´¥å›æˆ¿ï¼Œé•¿å»Šå°½å¤´å´ä¼ æ¥äº†å¥³å°†é‚£ç˜¦çŒ«èˆ¬å°–ç»†çš„å£°éŸ³ã€‚

ã€Œæœé›¾ï¼Œæœ‰å®¢äººã€‚ã€

æœé›¾çš„èº«ä½“åƒµäº†ä¸€ä¸‹ï¼Œéšå³æ¾å¼›ä¸‹æ¥ã€‚å¥¹å°†çƒŸç®¡åœ¨çƒŸç°ç›†é‡Œè½»è½»ç£•äº†ç£•ï¼Œç«™èµ·èº«ï¼Œç†äº†ç†å¾®ä¹±çš„è¡£è¥Ÿã€‚å…«æ´¥å·²ç»å›°å¾—çœ¯çœ¼æ‰“å“ˆæ¬ äº†ã€‚æœé›¾å¯¹å¥¹å®‰æŠšåœ°ç¬‘äº†ç¬‘ï¼Œæ‘¸æ‘¸å¥¹çš„å¤´ã€‚

ä½ å·²ç»åœ¨"å±±ç«¹"é—´ç­‰ç€ã€‚

æœé›¾éš”ç€ä¸€é“åŠå¼€çš„éšœå­é—¨çœ‹è§ä½ ã€‚ä½ ååœ¨æˆ¿é—´ä¸­å¤®ï¼ŒèƒŒå¯¹ç€é—¨ï¼Œçœ‹ä¸æ¸…æ ·è²Œã€‚æˆ¿é—´é‡Œæ²¡æœ‰ç‚¹å¤ªå¤šçš„ç¯ï¼Œå½±å­è¢«çƒ›ç«æ‹‰å¾—å¾ˆé•¿ï¼Œæ²‰é»˜åœ°æŠ•åœ¨æ¦»æ¦»ç±³ä¸Šã€‚

å¥¹åœ¨é—¨å¤–è·ªåä¸‹æ¥ï¼Œå°†åŒæ‰‹å¹³æ”¾åœ¨è†ä¸Šï¼ŒæŒ‡å°–ä¾æ—§æ˜¯å‡‰çš„ã€‚å¥¹å¾®å¾®å‚ä¸‹å¤´ï¼Œéœ²å‡ºä¸€æ®µé›ªç™½çš„åé¢ˆï¼Œå£°éŸ³å¹³æ·¡æ— æ³¢ï¼Œåˆå¸¦ç€å°½åŠ›åšå‡ºçš„å®¢å¥—å’Œæ¸©æŸ”ã€‚

ã€Œè®©æ‚¨ä¹…ç­‰äº†ã€‚æˆ‘æ˜¯æœé›¾ã€‚ã€

<options>
<op>è½¬è¿‡èº«æ¥ï¼Œçœ‹ç€å¥¹</op>
<op>è¯¢é—®å¥¹æ˜¯å¦æ„¿æ„å…¥åº§é™ªé…’</op>
<op>é€’ç»™å¥¹ä¸€ä¸ªæš–ç‚‰ï¼Œè¯´"æ‰‹å†°ï¼Œå…ˆæš–æš–å§"</op>
</options>`,

            day: `æ­£æœˆé‡Œçš„å¯’æš„åˆšè¿‡ï¼Œå¤–å¤´çš„å¯’æ°”ä»¿ä½›èƒ½æŠŠå±‹æªä¸Šå‚ç€çš„å†°æŸ±åˆ‡æ–­ã€‚

å…«æ´¥æ¨å¼€éš”é—¨ï¼Œé›é¸Ÿä¼¼çš„é£äº†è¿›æ¥ï¼Œå¸¦æ¥ä¸€é˜µå†·é£ã€‚å¥¹é‚£åŒçœ¼ç›åƒç»ç’ƒç å­ä¸€æ ·é—ªé—ªå‘å…‰ï¼Œè„¸é¢Šå› ä¸ºå…´å¥‹è€Œæ³›ç€å¥åº·çš„çº¢è‰²ã€‚

ã€Œæœé›¾é˜¿å§Šï¼Œå…«å¹¡è¡—ä¸Šçš„åº—é“ºéƒ½å¼€å¼ äº†ï¼Œæˆ‘ä»¬ä¸€èµ·å»çœ‹çœ‹å§ï¼å¬è¯´æœ‰å–é‚£ç§é—ªé—ªå‘å…‰çš„èœ»è›‰ç å‘¢ï¼ã€

æœé›¾æ­£å¯¹ç€ç«ç›†å–æš–ï¼Œé—»è¨€åªæ˜¯å¾€å¤¹æ£‰å•è¡£é‡Œç¼©äº†ç¼©èº«å­ï¼Œè¿çœ‰æ¯›éƒ½æ‡’å¾—æŠ¬ä¸€ä¸‹ã€‚

ã€Œä¸è¦ï¼Œå¤ªå†·äº†ã€‚ã€

å¯¹äºç”Ÿæ¥å°±åœ¨å‰åŸçš„æœé›¾æ¥è¯´ï¼Œå› ç«ç¾è€Œæµç¦»å¤±æ‰€å·²æ˜¯å¸¸äº‹ã€‚ä½†è¿™ä¸´æ—¶æ­å»ºçš„æ¸¸é‡Œï¼Œå¯¹åä¸‰å²æ‰è¢«é¢†æ¥çš„å…«æ´¥è€Œè¨€ï¼Œå¤„å¤„éƒ½æ˜¯æ–°å¥‡ã€‚æ›´ä½•å†µï¼Œæ­£æœˆé‡Œçš„å…«å¹¡è¡—ç¡®å®çƒ­é—¹å¾—èƒ½è®©ä»»ä½•äººå¿ƒå¤´é›€è·ƒã€‚

ã€Œåˆ«è¿™ä¹ˆè¯´å˜›ï¼Œå‘ï¼Œä¸€èµ·å»å§ã€‚ã€

å…«æ´¥å‡ æ­¥è·‘è¿›æ¥ï¼Œä¸å®¹åˆ†è¯´åœ°æ‹‰èµ·æœé›¾å†°å‡‰çš„æ‰‹ã€‚å¥¹çš„æ‰‹å¿ƒå€’æ˜¯å¾ˆæš–ã€‚

ã€Œä½ å¯çœŸæœ‰ç²¾ç¥ã€‚ç»™ä½ é›¶é’±ï¼Œå’Œä¸‰æ´¥å¥¹ä»¬ä¸€èµ·å»å§ã€‚ã€

ã€Œä¸è¦ï¼Œä¸‰æ´¥è¢«å®¢äººå«èµ°äº†ã€‚ã€

å…«æ´¥çš„å£°éŸ³ä½äº†ä¸‹å»ï¼Œå‚ä¸‹çœ¼ç‘çš„æ ·å­æœ‰äº›è½å¯ã€‚èº«ä¸ºé˜¿å§Šï¼Œçœ‹ç€å¦¹å¥³éƒä¸€ä¸ªäººå­¤é›¶é›¶åœ°å»é€›åº™ä¼šï¼Œä¹Ÿå®åœ¨æœ‰äº›å¯æ€œã€‚æœé›¾åœ¨å¿ƒé‡Œå¹äº†å£æ°”ï¼Œç»ˆç©¶è¿˜æ˜¯ç¼“ç¼“ç«™èµ·èº«ã€‚*ç’ç€æ¥¼ä¸»æºœå‡ºå»ä¸€ä¸‹ï¼Œåº”è¯¥ä¸ç¢äº‹ã€‚*

å‘¼å‡ºçš„ç™½æ°”æ¶ˆæ•£åœ¨æ¹›è“å¦‚æ´—çš„æ™´ç©ºä¸‹ã€‚æ·±å·å…«å¹¡å‰é«˜è€¸çš„é¸Ÿå±…ä¸‹ï¼Œå‚é“ä¸ŠæŒ¤æ»¡äº†äººã€‚åˆ°å¤„éƒ½æ˜¯ä¸æ–½ç²‰é»›çš„æ¸¸å¥³å’Œè‚†æ„è·‘é—¹çš„å­©ç«¥ã€‚å°è´©é«˜äº¢çš„å«å–å£°ã€é¼“ä¹å£°å’Œå¥³äººä»¬æ— å¿§æ— è™‘çš„æ¬¢ç¬‘æ··æ‚åœ¨ä¸€èµ·ï¼Œè®©æœé›¾æœ‰äº›å¤´æ™•ã€‚èº«æ—çš„å…«æ´¥å´åƒæ¸¸è¿›æ°´é‡Œçš„é±¼ï¼Œå…´å¥‹åœ°ä¸œå¼ è¥¿æœ›ï¼Œç´§ç´§ç‰µç€å¥¹çš„æ‰‹ã€‚

ã€Œé˜¿å§Šï¼Œå–èœ»è›‰ç çš„åº—åœ¨å“ªé‡Œå‘€ï¼Ÿã€

ã€Œäººæœ€å¤šçš„åœ°æ–¹ï¼Œåº”è¯¥å°±æ˜¯äº†å§ã€‚ã€

æœé›¾è¢«äººæ½®æ¨æ¡ç€ï¼Œå‹‰å¼ºæŠ¬æ‰‹æŒ‡å‘è¿œå¤„ã€‚å…«æ´¥å¼€å¿ƒåœ°åº”äº†ä¸€å£°ï¼Œæ‹‰ç€å¥¹ä¾¿è¦å¾€äººç¾¤é‡Œé’»ã€‚é‚£è‚¡åŠ›é“å‡ ä¹è®©æœé›¾ä¸€ä¸ªè¸‰è·„ã€‚

ã€Œç­‰ç­‰ï¼Œå°å¿ƒæ‘”å€’ï¼ã€

è¯éŸ³æœªè½ï¼Œä¸€è‚¡æ›´æ±¹æ¶Œçš„äººæµªæ¶Œæ¥ã€‚å…«æ´¥ã€Œå•Šã€åœ°è½»å«ä¸€å£°ï¼Œæ¸©æš–çš„æ‰‹æŒ‡ä»æœé›¾çš„æŒå¿ƒæ»‘è„±ã€‚åªä¸€ç¬é—´ï¼Œé‚£å°å°çš„èº«å½±å°±è¢«äººç¾¤åæ²¡ï¼Œä¸è§äº†è¸ªå½±ã€‚

*æ—©çŸ¥é“å°±ä¸è¯¥å‡ºæ¥ã€‚*æœé›¾ç«™åœ¨åŸåœ°ï¼Œè¢«äººæµæŒ¤å¾—ä¸œå€’è¥¿æ­ªï¼Œä¸ç¦çš±èµ·äº†çœ‰ã€‚

ä¸ç­‰å¥¹ç«™ç¨³ï¼Œåˆä¸€è‚¡åŠ›é“ä»ä¾§é¢æ’ä¸Šè‚©å¤´ã€‚è¿™ä¸€æ¬¡ï¼Œå¥¹æ²¡èƒ½ç¨³ä½èº«å½¢ï¼Œè·Œååœ¨å†°å†·çš„åœ°ä¸Šã€‚äººç¾¤ä¾æ—§æ¯«ä¸ç•™æƒ…åœ°ä»èº«æ—æŒ¤è¿‡ã€‚

æœé›¾æ­£è¦æ’‘ç€åœ°é¢èµ·èº«ï¼Œå´å‘ç°ä½ åœåœ¨äº†å¥¹çš„é¢å‰ï¼ŒæŒ¡ä½äº†æ¶ŒåŠ¨çš„äººæ½®ã€‚

å…«æ´¥æ—©å·²ä¸è§äº†è¸ªå½±ã€‚

<options>
<op>ä¼¸æ‰‹æ‰¶å¥¹èµ·æ¥</op>
<op>é—®å¥¹"æ²¡äº‹å§ï¼Ÿéœ€è¦å¸®å¿™å—ï¼Ÿ"</op>
<op>å…ˆå¸®å¥¹æŒ¡ä½å‘¨å›´æ¶ŒåŠ¨çš„äººç¾¤</op>
</options>`
          };

          // æ ¹æ® selectedOpening è¿”å›å¯¹åº”çš„å¼€åœºç™½
          return openingContents[this.selectedOpening] || openingContents.night;
        },

        // åˆ‡æ¢å¼€åœºç™½
        changeOpening() {
          if (!this.storyStarted || this.messages.length === 0) {
            // æ•…äº‹è¿˜æœªå¼€å§‹ï¼Œåªæ›´æ–° previousOpening
            this.previousOpening = this.selectedOpening;
            return;
          }

          // ç¡®è®¤æ˜¯å¦è¦åˆ‡æ¢å¼€åœºç™½
          if (this.messages.length > 1) {
            if (!confirm('åˆ‡æ¢å¼€åœºç™½å°†æ¸…ç©ºå½“å‰å¯¹è¯ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
              // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤ä¹‹å‰çš„é€‰æ‹©
              this.selectedOpening = this.previousOpening;
              return;
            }
          }

          // æ›´æ–° previousOpening
          this.previousOpening = this.selectedOpening;

          // æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
          this.messages = [];

          // æ·»åŠ æ–°çš„å¼€åœºç™½
          this.messages.push({
            role: 'assistant',
            content: this.getOpeningGreeting()
          });
        },

        // å¼€å§‹æ•…äº‹
        async startStory() {
          if (!this.character.name) {
            alert('è¯·è¾“å…¥æ‚¨çš„å§“å');
            return;
          }

          this.storyStarted = true;
          this.messages = [];

          // æ›´æ–° previousOpening ä¸ºå½“å‰é€‰æ‹©
          this.previousOpening = this.selectedOpening;

          // æ·»åŠ å›ºå®šçš„å¼€åœºç™½
          this.messages.push({
            role: 'assistant',
            content: this.getOpeningGreeting()
          });

          this.navigate('story');
        },

        // å‘é€æ¶ˆæ¯
        async sendMessage() {
          if (!this.userInput.trim() || this.isLoading) return;

          const userMessage = this.userInput.trim();
          this.userInput = '';

          this.messages.push({
            role: 'user',
            content: userMessage
          });

          // æ»šåŠ¨åˆ°åº•éƒ¨
          this.$nextTick(() => {
            const container = this.$refs.messagesContainer;
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          });

          await this.getAIResponse(userMessage, false);
        },

        // æ¸…ç†æ¶ˆæ¯å†…å®¹ï¼Œç§»é™¤optionsæ ‡ç­¾ï¼ˆé˜²æ­¢AIäº§ç”Ÿæƒ¯æ€§ï¼‰
        cleanMessageContent(content) {
          return content.replace(/<options>[\s\S]*?<\/options>/g, '').trim();
        },

        // è·å–AIå“åº”
        async getAIResponse(userMessage, isFirst) {
          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ªï¼Œè¯·ç¨åå†è¯•');
            return;
          }

          this.isLoading = true;

          try {
            // æˆªå–æœ€è¿‘30æ¡æ¶ˆæ¯ï¼ˆå·²åŒ…å«åˆšåˆšæ·»åŠ çš„ç”¨æˆ·æ¶ˆæ¯ï¼‰
            const recentMessages = this.messages.slice(-30);

            // æ¸…ç†å†å²æ¶ˆæ¯ä¸­çš„optionsæ ‡ç­¾ï¼Œé˜²æ­¢AIäº§ç”Ÿæƒ¯æ€§
            const cleanedMessages = recentMessages.map(msg => ({
              role: msg.role,
              content: this.cleanMessageContent(msg.content)
            }));

            // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œç”¨ <last_input> æ ‡ç­¾å¼ºè°ƒ
            for (let i = cleanedMessages.length - 1; i >= 0; i--) {
              if (cleanedMessages[i].role === 'user') {
                cleanedMessages[i].content = `<last_input>\n${cleanedMessages[i].content}\n</last_input>`;
                break;
              }
            }

            // ä½¿ç”¨æ¨¡å—åŒ–çš„å®Œæ•´ç³»ç»Ÿæç¤ºè¯
            const systemPrompt = this.buildSystemPrompt();

            // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼šç³»ç»Ÿæç¤ºè¯ + å¯¹è¯å†å² + å¼ºè°ƒåŒº
            // ç»“æ„ï¼šä¸»æç¤ºè¯ - æè¿°åŒº - æŒ‡å¯¼åŒº - å¼€åœºç™½ï¼ˆå·²åœ¨messagesä¸­ï¼‰ - èŠå¤©è®°å½• - å¼ºè°ƒåŒº
            const messages = [
              { role: 'user', content: systemPrompt },
              ...cleanedMessages,
              { role: 'user', content: this.getEmphasis() }
            ];

            let aiResponse = '';

            await window.dzmm.completions(
              {
                model: this.selectedModel,
                messages: messages,
                maxTokens: 2000
              },
              (newContent, done) => {
                aiResponse = newContent;

                if (done) {
                  this.messages.push({
                    role: 'assistant',
                    content: aiResponse
                  });

                  this.isLoading = false;

                  this.$nextTick(() => {
                    const container = this.$refs.messagesContainer;
                    if (container) {
                      container.scrollTop = container.scrollHeight;
                    }
                  });
                }
              }
            );

          } catch (error) {
            console.error('AI å“åº”é”™è¯¯ï¼š', error);
            alert('è·å– AI å“åº”å¤±è´¥ï¼Œè¯·é‡è¯•');
            this.isLoading = false;
          }
        },

        // é‡æ–°ç”ŸæˆæŒ‡å®šAIæ¶ˆæ¯
        async rerollMessage(messageIndex) {
          if (!this.dzmmReady || this.rerollingIndex !== null) {
            return;
          }

          // ç¡®ä¿æ˜¯AIæ¶ˆæ¯
          if (this.messages[messageIndex].role !== 'assistant') {
            return;
          }

          this.rerollingIndex = messageIndex;

          try {
            // è·å–è¯¥æ¶ˆæ¯ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡
            const contextMessages = this.messages.slice(0, messageIndex);

            // æˆªå–æœ€è¿‘30æ¡
            const recentMessages = contextMessages.slice(-30);

            // æ¸…ç†å†å²æ¶ˆæ¯ä¸­çš„optionsæ ‡ç­¾
            const cleanedMessages = recentMessages.map(msg => ({
              role: msg.role,
              content: this.cleanMessageContent(msg.content)
            }));

            // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œç”¨ <last_input> æ ‡ç­¾å¼ºè°ƒ
            for (let i = cleanedMessages.length - 1; i >= 0; i--) {
              if (cleanedMessages[i].role === 'user') {
                cleanedMessages[i].content = `<last_input>\n${cleanedMessages[i].content}\n</last_input>`;
                break;
              }
            }

            // ä½¿ç”¨æ¨¡å—åŒ–çš„å®Œæ•´ç³»ç»Ÿæç¤ºè¯
            const systemPrompt = this.buildSystemPrompt();

            // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼šç³»ç»Ÿæç¤ºè¯ + å¯¹è¯å†å² + å¼ºè°ƒåŒº
            const messages = [
              { role: 'user', content: systemPrompt },
              ...cleanedMessages,
              { role: 'user', content: this.getEmphasis() }
            ];

            let aiResponse = '';

            await window.dzmm.completions(
              {
                model: this.selectedModel,
                messages: messages,
                maxTokens: 2000
              },
              (newContent, done) => {
                aiResponse = newContent;

                if (done) {
                  // æ›¿æ¢è¯¥ä½ç½®çš„æ¶ˆæ¯å†…å®¹
                  this.messages[messageIndex].content = aiResponse;
                  this.rerollingIndex = null;

                  this.$nextTick(() => {
                    const container = this.$refs.messagesContainer;
                    if (container) {
                      container.scrollTop = container.scrollHeight;
                    }
                  });
                }
              }
            );

          } catch (error) {
            console.error('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼š', error);
            alert('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            this.rerollingIndex = null;
          }
        },

        // å¼€å§‹ç¼–è¾‘ç”¨æˆ·æ¶ˆæ¯
        startEdit(index, content) {
          this.editingIndex = index;
          this.editingContent = content;
        },

        // å–æ¶ˆç¼–è¾‘
        cancelEdit() {
          this.editingIndex = null;
          this.editingContent = '';
        },

        // ä¿å­˜ç¼–è¾‘å¹¶é‡æ–°ç”Ÿæˆåç»­å¯¹è¯
        async saveEdit(index) {
          if (!this.editingContent.trim()) {
            alert('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º');
            return;
          }

          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ª');
            return;
          }

          // æ›´æ–°è¯¥æ¶ˆæ¯å†…å®¹
          this.messages[index].content = this.editingContent.trim();

          // åˆ é™¤è¯¥æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
          this.messages = this.messages.slice(0, index + 1);

          // é€€å‡ºç¼–è¾‘æ¨¡å¼
          this.editingIndex = null;
          this.editingContent = '';

          // è‡ªåŠ¨è§¦å‘AIå›å¤
          await this.getAIResponse(this.messages[index].content, false);
        },

        // åˆ é™¤ç”¨æˆ·æ¶ˆæ¯åŠå…¶ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
        deleteMessage(index) {
          // ç¡®è®¤åˆ é™¤
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯åŠå…¶ä¹‹åçš„æ‰€æœ‰å¯¹è¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
            return;
          }

          // åˆ é™¤è¯¥æ¶ˆæ¯åŠå…¶ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
          this.messages = this.messages.slice(0, index);

          // å¦‚æœåˆ é™¤åæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œæç¤ºç”¨æˆ·
          if (this.messages.length === 0) {
            // å¯é€‰ï¼šè‡ªåŠ¨è¿”å›æ¬¢è¿é¡µæˆ–é‡æ–°å¼€å§‹
            // this.navigate('welcome');
          }
        },

        // åŠ è½½æ‰€æœ‰å­˜æ¡£æ§½ä¿¡æ¯
        async loadSaveSlots() {
          if (!this.dzmmReady) return;

          for (let i = 0; i < this.saveSlots.length; i++) {
            const slotId = this.saveSlots[i].id;
            try {
              const result = await window.dzmm.kv.get(`yoshiwara_save_slot_${slotId}`);
              if (result.value) {
                const data = JSON.parse(result.value);
                this.saveSlots[i] = {
                  id: slotId,
                  empty: false,
                  characterName: data.character.name,
                  gender: data.character.gender,
                  messageCount: data.messages.length,
                  selectedModel: data.selectedModel,
                  selectedOpening: data.selectedOpening || 'night',
                  timestamp: data.timestamp,
                  lastMessage: data.messages.length > 0
                    ? data.messages[data.messages.length - 1].content.slice(0, 50) + '...'
                    : ''
                };
              }
            } catch (error) {
              console.error(`åŠ è½½å­˜æ¡£æ§½ ${slotId} å¤±è´¥:`, error);
            }
          }
        },

        // æ‰“å¼€å­˜æ¡£é¡µé¢ï¼ˆä¿å­˜æ¨¡å¼ï¼‰
        async saveGame() {
          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ª');
            return;
          }
          await this.loadSaveSlots();
          this.currentSaveOperation = 'save';
          this.navigate('saves');
        },

        // æ‰“å¼€å­˜æ¡£é¡µé¢ï¼ˆè¯»å–æ¨¡å¼ï¼‰
        async loadGame() {
          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ª');
            return;
          }
          await this.loadSaveSlots();
          this.currentSaveOperation = 'load';
          this.navigate('saves');
        },

        // ä¿å­˜åˆ°æŒ‡å®šæ§½ä½
        async saveToSlot(slotId) {
          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ª');
            return;
          }

          // æ£€æŸ¥æ˜¯å¦ä¼šè¦†ç›–å·²æœ‰å­˜æ¡£
          const slot = this.saveSlots.find(s => s.id === slotId);
          if (!slot.empty) {
            if (!confirm(`å­˜æ¡£æ§½ ${slotId} å·²æœ‰å­˜æ¡£ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
              return;
            }
          }

          const saveData = {
            character: this.character,
            messages: this.messages,
            selectedModel: this.selectedModel,
            selectedOpening: this.selectedOpening,
            timestamp: new Date().toISOString()
          };

          try {
            await window.dzmm.kv.put(`yoshiwara_save_slot_${slotId}`, JSON.stringify(saveData));
            alert('å­˜æ¡£æˆåŠŸï¼');
            await this.loadSaveSlots();
          } catch (error) {
            console.error('å­˜æ¡£å¤±è´¥ï¼š', error);
            alert('å­˜æ¡£å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        // ä»æŒ‡å®šæ§½ä½åŠ è½½
        async loadFromSlot(slotId) {
          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ª');
            return;
          }

          try {
            const result = await window.dzmm.kv.get(`yoshiwara_save_slot_${slotId}`);

            if (result.value) {
              const saveData = JSON.parse(result.value);

              this.character = saveData.character;
              this.messages = saveData.messages;
              this.selectedModel = saveData.selectedModel || 'nalang-max-0826';
              this.selectedOpening = saveData.selectedOpening || 'night';
              this.previousOpening = this.selectedOpening; // åŒæ­¥ previousOpening
              this.storyStarted = true;

              this.navigate('story');
              alert('è¯»å–å­˜æ¡£æˆåŠŸï¼');
            } else {
              alert('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£');
            }
          } catch (error) {
            console.error('è¯»å–å­˜æ¡£å¤±è´¥ï¼š', error);
            alert('è¯»å–å­˜æ¡£å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        // åˆ é™¤æŒ‡å®šæ§½ä½
        async deleteSlot(slotId) {
          if (!this.dzmmReady) {
            alert('DZMM API å°šæœªå°±ç»ª');
            return;
          }

          if (!confirm(`ç¡®å®šè¦åˆ é™¤å­˜æ¡£æ§½ ${slotId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            return;
          }

          try {
            await window.dzmm.kv.delete(`yoshiwara_save_slot_${slotId}`);
            alert('åˆ é™¤æˆåŠŸï¼');
            // é‡ç½®è¯¥æ§½ä½çŠ¶æ€
            const slotIndex = this.saveSlots.findIndex(s => s.id === slotId);
            this.saveSlots[slotIndex] = { id: slotId, empty: true };
          } catch (error) {
            console.error('åˆ é™¤å¤±è´¥ï¼š', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        // å¯Œæ–‡æœ¬æ¸²æŸ“ï¼ˆstyle å±æ€§ä½¿ç”¨å•å¼•å·é¿å…å†²çªï¼‰
        renderRichText(text) {
          if (!text) return '';

          // 1. å…ˆæå– options å—ï¼Œç”¨å ä½ç¬¦æ›¿æ¢
          const optionsMap = [];
          let result = text.replace(/<options>([\s\S]*?)<\/options>/g, function(match, optionsContent) {
            const placeholder = '___OPTIONS_PLACEHOLDER_' + optionsMap.length + '___';
            optionsMap.push(optionsContent);
            return placeholder;
          });

          // 2. å¤„ç†å¯Œæ–‡æœ¬æ ¼å¼ï¼ˆæ˜Ÿå·ã€å¼•å·ã€æ¢è¡Œï¼‰
          result = result
            // æ˜Ÿå· â†’ æ–œä½“ç°è‰²ï¼ˆç§»é™¤æ˜Ÿå·æ ‡è®°ï¼Œåªä¿ç•™æ ·å¼ï¼‰
            .replace(/\*([^*]+)\*/g, function(match, content) {
              return "<span style='font-style: italic; color: #666;'>" + content + "</span>";
            })
            // æ—¥æ–‡å¼•å· â†’ æ·±çº¢è‰²ï¼ˆä¿ç•™å¼•å·ï¼‰
            .replace(/ã€Œ([^ã€]+)ã€/g, function(match, content) {
              return "<span style='color: hsl(355, 75%, 48%); font-weight: bold;'>ã€Œ" + content + "ã€</span>";
            })
            // è‹±æ–‡å¼•å· â†’ é‡‘è‰²ï¼ˆä¿ç•™å¼•å·ï¼‰
            .replace(/"([^"]+)"/g, function(match, content) {
              return "<span style='color: hsl(45, 85%, 58%); font-weight: bold;'>\"" + content + "\"</span>";
            })
            // æ¢è¡Œç¬¦
            .replace(/\n/g, '<br>');

          // 3. æœ€åå¤„ç† optionsï¼Œæ›¿æ¢å›å ä½ç¬¦ï¼ˆç‹¬ç«‹æ°”æ³¡æ ·å¼ï¼‰
          optionsMap.forEach(function(optionsContent, index) {
            const placeholder = '___OPTIONS_PLACEHOLDER_' + index + '___';
            const options = optionsContent.match(/<op>(.*?)<\/op>/g) || [];
            const buttons = options.map(function(opt) {
              const optionText = opt.replace(/<\/?op>/g, '').trim();
              const escapedText = optionText.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
              return '<button class="quick-reply-option" data-option="' + escapedText + '" style="display: inline-block; margin: 4px; padding: 8px 16px; border: 2px solid hsl(45, 85%, 58%); background: transparent; color: hsl(45, 85%, 58%); border-radius: 20px; cursor: pointer; font-size: 0.875rem; transition: all 0.3s; white-space: normal; text-align: left;" onmouseover="this.style.background=&#39;hsl(45, 85%, 58%)&#39;; this.style.color=&#39;hsl(210, 30%, 15%)&#39;" onmouseout="this.style.background=&#39;transparent&#39;; this.style.color=&#39;hsl(45, 85%, 58%)&#39;">' + optionText + '</button>';
            }).join('');
            // ç‹¬ç«‹æ°”æ³¡ï¼šä¸æ­£æ–‡åˆ†ç¦»ï¼Œæœ‰ç‹¬ç«‹èƒŒæ™¯å’Œè¾¹æ¡†
            const optionsHtml = '</div><div style="margin-top: 8px; padding: 12px; background: linear-gradient(to bottom, hsl(45, 85%, 98%), hsl(45, 85%, 95%)); border: 1px solid hsl(45, 85%, 70%); border-radius: 12px; display: flex; flex-wrap: wrap; gap: 4px;"><div style="width: 100%; font-size: 0.75rem; color: hsl(45, 60%, 40%); margin-bottom: 4px;">ç§è¯­</div>' + buttons + '</div><div style="display:none;">';
            result = result.replace(placeholder, optionsHtml);
          });

          return result;
        },

        // å¤„ç†å¿«é€Ÿå›å¤é€‰é¡¹ç‚¹å‡»
        handleQuickReply(event) {
          const button = event.target.closest('[data-option]');
          if (!button) return;

          const optionText = button.getAttribute('data-option');
          if (!optionText || this.isLoading) return;

          // å¡«å……åˆ°è¾“å…¥æ¡†å¹¶è‡ªåŠ¨å‘é€
          this.userInput = optionText;
          this.sendMessage();
        },

        // æ—¶é—´æ ¼å¼åŒ–
        formatTime(seconds) {
          if (!seconds || isNaN(seconds)) return '0:00';
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        },

        // è·å–èŒä¸šæ ‡ç­¾
        getOccupationLabel(value) {
          const labels = {
            'merchant': 'å•†äºº',
            'samurai': 'æ­¦å£«',
            'artist': 'æ–‡äºº',
            'doctor': 'åŒ»å¸ˆ',
            'other': 'å…¶ä»–'
          };
          return labels[value] || value;
        }
      }));
    });
  </script>
</body>
</html>
